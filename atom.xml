<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[jasonwryan.com]]></title>
  <link href="http://jasonwryan.github.com/atom.xml" rel="self"/>
  <link href="http://jasonwryan.github.com/"/>
  <updated>2012-11-20T19:53:44+13:00</updated>
  <id>http://jasonwryan.github.com/</id>
  <author>
    <name><![CDATA[Jason Ryan]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[A Vimprobable Walkthrough]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/11/20/vimprobable/"/>
    <updated>2012-11-20T18:58:00+13:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/11/20/vimprobable</id>
    <content type="html"><![CDATA[<p><img class="left" src="https://dl.dropbox.com/u/261312/Blog-images/vimprobable-logo.png" title="'Vimprobable logo'" >
I have written about <a href="http://vimprobable.org" title="Vimprobable homepage">Vimprobable</a>
a couple of times over the last two years<sup>1</sup>,
it is one of those projects that, for a variety of reasons, I have picked up
and stuck with.  Like <a href="http://dwm.suckless.org" title="dwm homepage">dwm</a>,
<a href="http://vim.org" title="Vim homepage">Vim</a> and
<a href="http://tmux.sourceforge.net/" title="tmux homepage">tmux</a>,
it is an essential part of my working environment and is installed on all of my
machines, where it is my default browser. It&#8217;s simplicity, power and
configurability are why, despite looking at a few other similar projects, I
have stuck with Vimprobable since first installing it.</p>

<p>After my last post, a <a href="http://jasonwryan.com/blog/2012/09/28/screencast/" title="An intro to dwm">dwm screencast</a>,
I wanted to have another crack at making a decent screencast. Sadly,
this is not it.  I can say that making a <em>good</em> screencast is not a simple
accomplisment; there are so many elements that require significant attention. I
spent a good many hours this time around playing with custom Xorg modelines,
<code>ffmpeg</code>&#8217;s arcane encoding options and, to be frank, the final product is just not worth
all that effort.</p>

<p>I&#8217;m going to stick with plain text from now on. It requires little more from me
than a passing acquaintance with the subject matter, some loosely held and
<a href="http://jasonwryan.com/blog/2012/08/18/trolls/" title="Trolling Arch Linux">firmly expressed opinions</a>
and my unbridled confidence in the fact that anyone who
has read this far down the page is so bereft of other, more pressing things to
think about that they may inadvertently find a scintilla of amusement in here…</p>

<p>With that explanation out of the way, I give you my final screencast:</p>

<iframe src="http://player.vimeo.com/video/53829053?byline=0&amp;portrait=0&amp;badge=0&amp;color=ffffff" 
width="350" height="197" frameborder="0" webkitAllowFullScreen mozallowfullscreen allowFullScreen></iframe>


<p></p>

<p><a href="http://vimeo.com/53829053">An Introduction to Vimprobable</a> on 
<a href="http://vimeo.com">Vimeo</a>.</p>


<h4>Notes</h4>

<ol>
<li>First back in <a href="http://jasonwryan.com/blog/2010/10/07/vimprobable/">October, 2010</a> and then,
more recently, in <a href="http://jasonwryan.com/blog/2011/06/26/using-vimprobable/">June, 2011</a>.</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A dwm Screencast]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/09/28/screencast/"/>
    <updated>2012-09-28T09:18:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/09/28/screencast</id>
    <content type="html"><![CDATA[<p><img class="left" src="https://dl.dropbox.com/u/261312/Blog-images/dwm-logo.png" title="'dwm logo'" >
Over the last week as I have been at home convalescing I have, quite unaccountably,
found myself watching videos of tiling window managers. In all, I have probably watched
between twenty and thirty of these videos so I feel, quite confidently, that I have a
firm grasp of what constitutes the genre. Consequently, I also feel that I can&mdash;based
on the range of the material I have reviewed, and the scrutiny and attention therein
applied&mdash;share an unequivocal judgement as to the overall quality of the genre: it
sucks.</p>

<p>Moreover, these videos invariably suck in the same couple of ways; they always lack
any sort of narration, which means that you are stuck silently watching some sort of
paroxysm of window rearrangement without <em>any</em> context or explanation, as if the fact
that you can inflict this sort of injury on an X display is rationale enough. And,
secondly, just as frequently, they feature a cursor being dragged around the screen
doing the damage; using the mouse to demonstrate the capabilities of a tiling window
manager is the sort of vestigial behaviour more commonly associated with pagan
superstition or mild enfeeblement…</p>

<p>Rather that simply bask in the sense of superiority that these observations have
afforded me, I thought that I would make my own, more lasting, contribution to the
canon. I can only describe this process as instructive.</p>

<p><a href="http://www.youtube.com/watch?v=GQ5s6T25jCc"><img class="center" src="https://dl.dropbox.com/u/261312/Blog-images/tower.jpg" title="dwm screencast" ></a></p>

<p>The best that can be said of this video is that, while it sucks just as hard as the others
that I have reviewed over the past week, it has the distinguishing feature of at least
sucking <em>differently</em>. For example, it has an audio track, so in theory the actions on the
screen should be accompanied by the narrator&#8217;s soothing tones. Sadly, this is not the case.
The crappy quality of my headset, my hoarse throat, and most egregiously, my decision to eschew
post production and shoot it in one take means that the audio is poorly recorded, and at times
literally inarticulate, rambling.</p>

<p>If nothing else, the exercise has taught me to really appreciate the work of people who
do this thing well; Drew Neil&#8217;s excellent
<a href="http://vimcasts.org/" title="The Vimcasts homepage">Vimcasts</a> being a case in point.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Improved Notes Utility]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/09/01/notes-updated/"/>
    <updated>2012-09-01T10:09:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/09/01/notes-updated</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/notes.jpg" title="'Notepad image on Flickr'" >
Nearly two years ago, I posted about my adaption of a simple
<a href="http://jasonwryan.com/blog/2010/09/28/command-line-notes/" title="My post in 2010">command line note utility</a>.
I have used this setup on all of my machines on a daily basis since and it has worked
marvellously. Symlinking to a folder in
<a href="https://www.dropbox.com/home" title="Dropbox home">Dropbox</a> means that the notes are accessible
from all my machines, including my phone. There has only really been one aspect of this setup
that has been sub-optimal.</p>

<p>As an inveterate note-taker (this is one of the “benefits” of ageing; the speed with
which you forget information outpaces the acquisition of newer material) I have—in
those intervening years—built up quite a store of notes. Consequently, in order to
maintain a semblance of order, I have arranged them in a series of directories. There
is a minor flaw with this approach: retreiving a note depended on two factors, a) excellent
recall<sup>1</sup> and, b) accurately typing out the full path. Neither of these are things that I
am inherently good at or inclined to master.</p>

<p>This had been irritating me for some time before I came across this
<a href="http://unix.stackexchange.com/questions/11906/how-to-change-the-target-directory-for-tab-completion" title="Tab completion for notes function">question on Unix &amp; Linux StackExchange</a>.
This provided me with a partial solution to the issue but, as I note in my answer, I was not
able to solve it for nested directories, which was my particular use case. Once I had
muddled my way through the solution on U&amp;L I pushed it to the back of my mind and
tried to ignore it.</p>

<p>Recently, though, the accumulation of notes and the frustration of trying to access them
without <kbd>Tab</kbd> completion drove me to do something about it.</p>

<p>The documentation on
<a href="http://www.gnu.org/software/bash/manual/html_node/Programmable-Completion-Builtins.html" title="Bash Manual">programmable completion</a>
is typically terse and searching the web returns very little in the way of instructions
as to how to accomplish this.<sup>2</sup> Undeterred, I decided to hack up a completion
function that worked for nested directories.</p>

<p>What I arrived at was this:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nb">shopt</span> -s globstar
</span><span class='line'><span class="nb">shopt</span> -s progcomp
</span><span class='line'>
</span><span class='line'>n<span class="o">()</span> <span class="o">{</span> <span class="nv">$EDITOR</span> <span class="nv">$HOME</span>/.notes/<span class="s2">&quot;$*&quot;</span>.txt ;<span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="c"># completion for notes</span>
</span><span class='line'>_notes<span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="nb">local </span>cur
</span><span class='line'>    <span class="nv">cur</span><span class="o">=</span><span class="k">${</span><span class="nv">COMP_WORDS</span><span class="p">[COMP_CWORD]</span><span class="k">}</span>
</span><span class='line'>    <span class="nv">files</span><span class="o">=(</span><span class="nv">$HOME</span>/.notes/**<span class="o">)</span>
</span><span class='line'>    <span class="nv">file</span><span class="o">=</span><span class="s2">&quot;${files[@]##*/}&quot;</span>
</span><span class='line'>    <span class="nv">COMPREPLY</span><span class="o">=(</span> <span class="k">$(</span> <span class="nb">compgen</span> -f <span class="s2">&quot;${file[@]}&quot;</span> -- <span class="k">${</span><span class="nv">cur</span><span class="k">}</span> <span class="k">)</span> <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nb">complete</span> -o default -F _notes n
</span></code></pre></div></figure>


<p>The best that can be said about it is that it <em>nearly</em> works…<sup>3</sup></p>

<p>Realising that I was completely out of my depth, I turned to #bash for help, and
I was indeed fortunate that
<a href="https://github.com/geirha" title="geirha's Gitgub">geihra</a> offered some much needed
assistance. geirha&#8217;s solution is an elegant one:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>n<span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="nb">local </span>arg <span class="nv">files</span><span class="o">=()</span>; <span class="k">for </span>arg; <span class="k">do </span>files+<span class="o">=(</span> ~/<span class="s2">&quot;.notes/$arg&quot;</span> <span class="o">)</span>; <span class="k">done</span>
</span><span class='line'><span class="k">${</span><span class="nv">EDITOR</span><span class="k">:-</span><span class="nv">vi</span><span class="k">}</span> <span class="s2">&quot;${files[@]}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>_notes<span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="nb">local </span><span class="nv">files</span><span class="o">=(</span><span class="nv">$HOME</span>/.notes/**/<span class="s2">&quot;$2&quot;</span>*<span class="o">)</span>
</span><span class='line'>    <span class="o">[[</span> -e <span class="k">${</span><span class="nv">files</span><span class="p">[0]</span><span class="k">}</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">COMPREPLY</span><span class="o">=(</span> <span class="s2">&quot;${files[@]##~/.notes/}&quot;</span> <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nb">complete</span> -o default -F _notes n
</span></code></pre></div></figure>


<p>In addition to working exactly as I hoped, it had the benefit of introducing me
to a couple more bash concepts that I hadn&#8217;t encountered;
<a href="http://mywiki.wooledge.org/BashGuide/Arrays" title="Bash Guide on Greg's Wiki">adding elements to an array</a>
with <code>+=()</code> being one. For posterity, the full script is:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>n<span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="nb">local </span>arg <span class="nv">files</span><span class="o">=()</span>; <span class="k">for </span>arg; <span class="k">do </span>files+<span class="o">=(</span> ~/<span class="s2">&quot;.notes/$arg&quot;</span> <span class="o">)</span>; <span class="k">done</span>
</span><span class='line'><span class="k">${</span><span class="nv">EDITOR</span><span class="k">:-</span><span class="nv">vi</span><span class="k">}</span> <span class="s2">&quot;${files[@]}&quot;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>nls<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>tree -CR --noreport <span class="nv">$HOME</span>/.notes | awk <span class="s1">&#39;{ </span>
</span><span class='line'><span class="s1">    if (NF==1) print $1; </span>
</span><span class='line'><span class="s1">    else if (NF==2) print $2; </span>
</span><span class='line'><span class="s1">    else if (NF==3) printf &quot;  %s\n&quot;, $3 </span>
</span><span class='line'><span class="s1">    }&#39;</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'> <span class="c"># TAB completion for notes</span>
</span><span class='line'>_notes<span class="o">()</span> <span class="o">{</span>
</span><span class='line'><span class="nb">local </span><span class="nv">files</span><span class="o">=(</span><span class="nv">$HOME</span>/.notes/**/<span class="s2">&quot;$2&quot;</span>*<span class="o">)</span>
</span><span class='line'>    <span class="o">[[</span> -e <span class="k">${</span><span class="nv">files</span><span class="p">[0]</span><span class="k">}</span> <span class="o">]]</span> <span class="o">&amp;&amp;</span> <span class="nv">COMPREPLY</span><span class="o">=(</span> <span class="s2">&quot;${files[@]##~/.notes/}&quot;</span> <span class="o">)</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'><span class="nb">complete</span> -o default -F _notes n
</span></code></pre></div></figure>


<h4>Notes</h4>

<ol>
<li>The alternative to remembering the full path name is to list all of the notes before
each operation with the <code>nls</code> function; this is not ideal either…</li>
<li>Which means that it is either so straightforward that few have bothered to write up their
experiences (most likely), or so arcane that not many have bothered (how it
feels to me). However, there are a couple of pages that I referenced in addition
to the official documentation:

<ul>
<li><a href="http://www.gnu.org/software/bash/manual/html_node/Programmable-Completion-Builtins.html">Adam Backstrong&#8217;s post</a></li>
<li><a href="http://fahdshariff.blogspot.co.nz/2011/04/writing-your-own-bash-completion.html">Fahd Shariff&#8217;s post</a></li>
<li><a href="http://devmanual.gentoo.org/tasks-reference/completion/index.html">Gentoo Development Guide</a></li>
</ul>
</li>
<li>It fails, as geirha pointed out, because it breaks the filenames on whitespace.</li>
</ol>


<p>Creative Commons image on Flickr by
<a href="http://www.flickr.com/photos/nicholasjon/4101203095/" title="Field Notes etc on Flickr">nicholasjon</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Trolling Arch Linux]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/08/18/trolls/"/>
    <updated>2012-08-18T10:47:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/08/18/trolls</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/troll.jpg" title="'Troll on Flickr'" >
I posted recently about
<a href="http://jasonwryan.com/blog/2012/08/04/systemd/" title="Some thoughts on moving across…">my experiences shifting to systemd</a>
and how I found it, for all three of my Arch machines, to be a relatively simple and
straightforward process which, in the intervening weeks, has borne out the views of
the developers and other members of the community who have been using it for a longer
period—it works, and works well. At the start of this week, Stéphane Gaudreault
announced on Arch-dev-public the intention to
<a href="http://mailman.archlinux.org/pipermail/arch-dev-public/2012-August/023389.html" title="ML post seeking developer views">replace the original initscripts with systemd</a>.</p>

<p>The reaction by some to this announcement was, to me, quite disappointing. My view of
open source communities is that by participating you are entering into a social contract.
That contract is that, as you are reliant on the goodwill of the wider community it is
incumbent on you to ensure that your overall contribution—in whatever form—brings
more to the community than it takes away. At the very least, you can strive to ensure
that it is a value neutral exchange.</p>

<p>Sadly, for some of the trolls on the <acronym title="Mailing lists">MLs</acronym>, that
is patently not the case. I want to take a closer look at just one of those threads, for two
reasons. First, it is a textbook case of a particularly pernicious troll. And second, in
conjunction with some other factors, it had an especially damaging effect on the wider
community.</p>

<p>The thread in question is on Arch-general, the largest of the mailing lists. It has
the suitably alarmist title
<a href="http://mailman.archlinux.org/pipermail/arch-general/2012-August/029856.html" title="A trolling we will go…">Think twice before moving to systemd</a>.
The troll, who has had only minimal involvement with the Arch community up until this
unfortunate moment starts by framing his “concern”<sup>1</sup>:</p>

<blockquote><p>I just became aware that Arch Linux plans to switch to systemd, and this worries me for several reasons.</p></blockquote>


<p>Felipe is worried. Ergo, <em>we</em> should be worried. Why should we be worried? Because,
despite the fact that systemd has been discussed and used by Archers since the
<a href="https://bbs.archlinux.org/viewtopic.php?id=96316" title="57 page thread on the Arch BBS">middle of 2010</a>,
it has just come to his attention and now, with the formidable powers of his intellect,
he has detected a disturbance in the force.</p>

<blockquote><p>I tried systemd a while ago in a brand new machine with Arch Linux and the boot was *much slower*. After some exchanges with Lennart Poettering and other people in Google+[1], it became clear I was on my own. Eventually I found the culprit: Fedora uses CONFIG_HZ_1000, and Arch Linux uses CONFIG_HZ_300. It became clear to me that systemd was not ready for prime time, it wasn&#8217;t thoroughly tested in a lot of machines, and if you have problems Lennart Poettering will blame you (PulseAudio sounds familiar?).</p></blockquote>


<p>The salient phrases here are “it became clear I was on my own” and the even more telling,
“it became clear to me that systemd was not ready for prime time.” Once I had managed to
wipe away the tears of gratitude that were coursing down my cheeks, I realized that Arch
finally had finally found what it had been missing for all these years: a saviour. We
were going to be OK after all.</p>

<p>Felipe has “found the culprit.” Despite the best efforts of the Arch developers, upstream,
the other distros that have been using it for considerably longer, and the experience of the
<a href="https://bbs.archlinux.org/viewtopic.php?pid=1147676" title="Thread on systemd - one of many">Arch users reported on our boards</a>,
no-one had the heroic ability to see through to the heart of this conundrum and expose
systemd for the fraud that it is.</p>

<p>But our gratitude should be tempered with some shame for we, the Arch community, have let
Felipe down. We haven&#8217;t lived up to the standards he expects of us. As he gently admonishes us:
“I was expecting more from the Arch Linux community.” Yes, Felipe, and you were right to.
We let you down; can you forgive us?</p>

<p>The thread goes on to generate more than 50 replies. All of them wasted.
His trolling is not interested in facts, in reason or logic; his method of argumentation is
not rational, and he is not interested in working toward an understanding
of the truth; he just wants to be right. At whatever cost to the wider community. These posts,
and trolls in other fora
<a href="https://lkml.org/lkml/2012/4/12/434" title="LKML exchange with Linus Torvalds">like this one</a>,<sup>2</sup>
are really about gratifying Felipe&#8217;s own voracious appetite for self-aggrandisement. In reality,
of course, it is a stunning illustration of the
<a href="https://secure.wikimedia.org/wikipedia/en/wiki/Dunning%E2%80%93Kruger_effect" title="Wikipedia entry">Dunning-Kruger effect</a>.
It would be pathetic if it were a victimless pursuit; but it is not.</p>

<p>Further down in the thread we see the inevitable frustration of the developer who leads
this work for Arch,
<a href="https://www.archlinux.org/developers/#tomegun" title="Tom's developer profile">Tom Gunderson</a>,
finally <a href="http://mailman.archlinux.org/pipermail/arch-general/2012-August/029933.html" title="Tom's reply quoting Linus">boil over</a>.
This precipitates another thread where Tom announces that he will
<a href="http://mailman.archlinux.org/pipermail/arch-general/2012-August/029960.html" title="Tom's mail to the list">no longer participate in this list</a>.
This is from the developer that has patiently and constructively engaged with Arch users on the
list around this issue for the past several months. On his own time.</p>

<p>That is the impact of trolls like Felipe. That is a direct effect of his selfishness on the
wider community. What has he brought to the community? Dissent, distraction and posturing.
What has he taken away? The ability for all of us to engage with one of the developers
of the software we all use. His presence on the list, and that of a few others,
has been nothing short of corrosive.</p>

<p>And as for the smoking gun, the config setting that no-one was smart enough to
discover? Denis A. Altoé Falqueto went to the trouble to build another kernel
and run a test and, contrary to Felipe who provided no such evidence,
<a href="http://mailman.archlinux.org/pipermail/arch-general/2012-August/030145.html" title="Denis' post">posted the results</a>.
You can guess the outcome.</p>

<h4>Notes</h4>

<ol>
<li>See the <a href="http://www.urbandictionary.com/define.php?term=concern+troll">concern troll</a>.</li>
<li>Read the whole thread to fully understand how obstinance can trump reason… See
also his <a href="http://felipec.wordpress.com/2012/05/26/no-mercurial-branches-are-still-not-better-than-git-ones-response-to-jhws-more-on-mercurial-vs-git-with-graphs/">own blog</a>
where he expresses incredulity that his comments on another blog have been deleted.</li>
</ol>


<p>Creative Commons image of the troll on Flickr by
<a href="http://www.flickr.com/photos/56380734@N05/6937763971/">Comrade Foot</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The Leap to systemd]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/08/04/systemd/"/>
    <updated>2012-08-04T09:32:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/08/04/systemd</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/leap.jpg" title="Leap image on Flickr" >
I posted a couple of weeks ago about the impact of some of the current
<a href="http://jasonwryan.com/blog/2012/07/19/breakage/" title="Post on the glibc change">changes to Arch Linux</a>.
There seems to be quite a bit of it about, because in conjunction with the move from
<span class="file">/lib</span> to <span class="file">/usr/lib</span>—and motivated by the same
overarching shifts in the other distributions—the other major change making its way through
the Arch community is the move to
<a href="http://freedesktop.org/wiki/Software/systemd" title="Project page">systemd</a>. This change, however, has
been more controversial because it marks a shift away from Arch&#8217;s central configuration
file, <a href="https://wiki.archlinux.org/index.php/Rc.conf" title="Arch wiki entry on rc.conf">/etc/rc.conf</a>;
a move that has disconcerted a number of people.</p>

<p>I&#8217;m not going to get into whether or not this move is consistent with
<a href="https://wiki.archlinux.org/index.php/The_Arch_Way" title="Wiki entry">The Arch Way</a>, because that has
been thrashed over extensively on the
<a href="http://mailman.archlinux.org/pipermail/arch-dev-public/2012-July/023283.html" title="ML thread on rc.conf">mailing</a>
<a href="http://mailman.archlinux.org/pipermail/arch-dev-public/2012-July/023258.html" title="And another one…">lists</a>,
but also—and more importantly—because Arch is a rolling release, which means change is <em>inevitable</em>.
What is more, after watching all the back and forth on the <acronym title="Mailing lists">ML</acronym>
and on the <a href="https://bbs.archlinux.org/viewtopic.php?id=96316&amp;p=1" title="Arch BBS thread on systemd">boards</a>, I am convinced that the
<a href="http://www.archlinux.org/developers/#tomegun" title="Tom Gunderson">developer overseeing this shift</a>
both knows what he is doing and is acting in the best interests of Arch.</p>

<p>This view has been validated by my experience of shifting to systemd on my machines.</p>

<p>When the new initscripts package was pushed to [testing] in the middle of last month,
I stripped out all of the redundant options in <span class="file">/etc/rc.conf</span>
and took the ten minutes or so to read about and then create the new files. I then spent some
time reading up on systemd, principally
<a href="http://0pointer.de/blog/projects/systemd-for-admins-1.html" title="One of TWELVE…">Lennart Poettering&#8217;s series of posts</a>,
the <a href="https://wiki.archlinux.org/index.php/Systemd" title="Good, but needing some structure">Arch wiki entry</a>
and the many and various
<a href="http://0pointer.de/public/systemd-man/" title="One for everything">manual pages</a>.</p>

<p>Over the last couple of days, I have migrated all of my machines over to systemd. I found it
to be a very straightforward process. I went for a pure systemd approach, for reasons I will
return to. Essentially, this is how I tackled it.</p>

<p>First, for each machine, I established what daemons were running. I did this by using
<a href="http://pikacode.com/jasonwryan/Veles/file/default/Scripts/daemons.sh" title="Pretty sure it is one of Xyne's">this shell script</a>
and cross checking entries in my <span class="file">/etc/rc.conf</span>. Then
it was just a matter of installing systemd:<sup>1</sup></p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>sudo pacman -S systemd systemd-sysvcompat systemd-arch-units
</span></code></pre></div></figure>


<p>The only outstanding file to be created was <span class="file">/etc/timezone</span>, the
others—all documented in <code>man rc.conf</code>—I had created earlier in the month. Then, with the
list of the services I would need running on each box, I enabled them. I think it is
fair to say that the only thing that is clunky about systemd is the command syntax for
managing units. Repeatedly typing <code>systemctl enable foo.service</code> is as tedious as it is
error prone, so I hacked up a
<a href="http://pikacode.com/jasonwryan/Centurion/file/default/Scripts/sysd" title="sysd - *so* much easier">wrapper script</a>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>sysd <span class="nb">enable </span>acpid
</span><span class='line'>sysd <span class="nb">enable </span>lvm
</span><span class='line'>etc…
</span></code></pre></div></figure>


<p>I also activated some additional gettys, as I like to log into a tmux session in TTY2 when
I don&#8217;t need or want to start <code>X</code>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>ln -sf /usr/lib/systemd/system/getty@.service /etc/systemd/system/getty.target.wants/getty@tty2.service
</span></code></pre></div></figure>


<p>And I misguidedly wrote a couple of custom service files that turned out to be
<a href="https://bbs.archlinux.org/viewtopic.php?id=146207" title="BBS post on said files">completely unnecessary</a>;
and then I was done.</p>

<p>On all three boxes I rebooted and that was it. The only issue I experienced was
the final shutdown after removing initscripts and before booting up with
systemd. After issuing <code>shutdown -r now</code> the process
hung with a message about a missing <span class="file">inittab</span> file.
In retrospect, I should have added <code>init=/bin/systemd</code> to my kernel parameters
and not unistalled instiscripts until I had booted with systemd. This has
now been added to the
<a href="https://wiki.archlinux.org/index.php/Systemd" title="Archwiki systemd page">systemd wiki page</a>.</p>

<p>Overall, though: no real drama, just a blur of text<sup>2</sup> and then the
login prompt. While I haven&#8217;t seen a dramatic decrease in boot time,
booting does <em>feel</em> a bit snappier and two of my three machines shutdown
markedly more quickly. Consider me sold.</p>

<p>That brings me back to the decision to opt for a pure systemd approach, rather than
hanging on to a completely eviscerated <span class="file">/etc/rc.conf</span>. The
Arch community has been told that the intention is to
<a href="https://bbs.archlinux.org/viewtopic.php?pid=1133957#p1133957" title="BBS post by tomegun">support the rc.conf format forever</a>;
I can&#8217;t help but think this is a mistake. In the same way that
<a href="https://wiki.archlinux.org/index.php/Pacman#Partial_upgrades_are_unsupported" title="Pacman entry on Arch Wiki">partial upgrades are unsupported</a>,
I think that systemd is Arch&#8217;s inevitable future and the community should be encouraged to accept that, <code>Syu</code> and
move on…</p>

<p>Having said that, I appreciate the consideration shown by the developers in wanting to assure
people that their choice would continue to be catered for; and perhaps, over time, people still
using initscripts will be regarded with the same sense of wry amusement as those who still show
up from time to time with <code>hal</code> in their <code>DAEMONS</code> line.</p>

<h3>Update 4/8/12</h3>

<p>Tom Gunderson, the developer who looks after this part of Arch, has clarified the
comment about the long term support for initscripts. As comments are hosted on
a third-party paltform, I thought that it should be included in the body of the
post.</p>

<blockquote><p>Just a clarification: regarding the (probably very unwise) promise of &#8220;supporting <span="file">rc.conf</span> forever&#8221;, the intended meaning was that initscripts will support the syntax, not that initscripts themselves will always stay around (nor that systemd will gain support for the syntax in case initscripts is dropped).</p><p>At the moment systemd <strong>does</strong> support <span class="file">rc.conf</span> (when installed in conjunction with initscripts), but this is meant as a transitional measure only, and will likely go away eventually (though probably not soon).</p></blockquote>


<h4>Notes</h4>

<ol>
<li>Note this approach will <em>remove</em> sysvinit and initscripts and <code>mv /etc/rc.conf{,.pacsave}</code>.</li>
<li>Make sure you remove <code>quiet</code> from your kernel parameters for your first systemd
boot so you can see that everything starts correctly…</li>
</ol>


<p>Creative commons image on Flickr by
<a href="http://www.flickr.com/photos/sovietuk/486119799/" title="leap by rick harrison">Tricky</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Sharing Mercurial Patchsets]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/07/26/guards/"/>
    <updated>2012-07-26T18:48:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/07/26/guards</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/guard.jpg" title="'On Guard image on Flickr'" >
In my last post, on
<a href="http://jasonwryan.com/blog/2012/07/24/queues/" title="You should read it…">Mercurial Queues</a>,
I outlined how you might use MQ to manage a
<a href="http://dwm.suckless.org/" title="Dynamic window manager">dwm</a> patchset.
Mercurial makes this process ridiculously easy, and this functionality is more
than enough to recommend it. However, where I think it really gets interesting
is when you share that same patchset across multiple machines and are easily
able to customize which patches in the queue are applied, based upon the
particular machine you are building dwm on.</p>

<p>For example, in my case I use dwm on all three of my machines: my desktop at home,
my laptop at work and my EeePC. Given the nature of each of these three machines,
though, I want a slightly different stack of patches applied. These differences
might extend only to particular rules applied in <span class="file">config.def.h</span>
based upon the number of tags I use, or the different applications that I run
at home as opposed to at work.</p>

<p>In any event, what I want to be able to do is maintain
<a href="http://pikacode.com/jasonwryan/dwm-patchset/files/default" title="Patchset on Pikacode">a single patchset</a>
in a mercurial repository, clone it to all my machines and then, using MQ,
filter which specific patches are applied. This is all possible using a killer
feature of MQ called
<a href="http://hgbook.red-bean.com/read/advanced-uses-of-mercurial-queues.html%20'Advanced%20uses%20of%20MQ%20in%20the%20Mercurial%20book">guards</a>.
Guards allow you to conditionally apply patches in a queue. Essentially, in
a queue, you “tag” a patch with a guard and—depending on whether or not the
guard is positive (to be applied), or negative (to be skipped)—when you
<code>hg qpush -a</code> MQ takes care of applying the correct patches in the queue.</p>

<p>So, in the case of my work laptop, I begin by cloning dwm and intializing
a patch queue:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nb">cd </span>Build/
</span><span class='line'>hg clone http://hg.suckless.org/dwm
</span><span class='line'>hg qinit -c
</span></code></pre></div></figure>


<p>I setup my <span class="file">.hgrc</span> within the patches directory so that
it points at the correct mercurial repository:</p>

<figure class='code'><figcaption><span>.hg/patches/.hg/hgrc </span></figcaption>
 <div class="highlight"><pre><code class='sh'><span class='line'> <span class="c"># Mercurial config file</span>
</span><span class='line'><span class="o">[</span>ui<span class="o">]</span>
</span><span class='line'><span class="nv">username</span> <span class="o">=</span> jasonwryan &lt;jasonwryan@gmail.com&gt;
</span><span class='line'><span class="nv">ssh</span> <span class="o">=</span> ssh -i ~/.ssh/bb -C
</span><span class='line'><span class="o">[</span>paths<span class="o">]</span>
</span><span class='line'><span class="nv">default</span> <span class="o">=</span> ssh://hg@pikacode.com/jasonwryan/dwm-patchset
</span></code></pre></div></figure>


<p>Then I pull down my dwm patchset from the mercurial repository
with <code>hg pull</code>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>pulling from ssh://hg@pikacode.com/jasonwryan/dwm-patchset
</span><span class='line'>requesting all changes
</span><span class='line'>adding changesets
</span><span class='line'>adding manifests
</span><span class='line'>adding file changes
</span><span class='line'>added 6 changesets with 16 changes to 10 files
</span><span class='line'><span class="o">(</span>run <span class="s1">&#39;hg update&#39;</span> to get a working copy<span class="o">)</span>
</span></code></pre></div></figure>


<p>After I update my local repo,<sup>1</sup> I can see the full patchset with
<code>hg qseries</code>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>setup.makefile
</span><span class='line'>base.config.customizations
</span><span class='line'>statuscolours
</span><span class='line'>cycle
</span><span class='line'>push
</span><span class='line'>bstack
</span><span class='line'>centurion.config
</span></code></pre></div></figure>


<p>Then, as I decribed in my previous post, I make the changes to
<span class="file">config.def.h</span> that are specific to this
machine:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>hg qnew veles.config
</span><span class='line'> <span class="c"># “hack, hack, hack…”</span>
</span><span class='line'>hg qrefresh
</span><span class='line'>hg qcommit -m <span class="s1">&#39;Adaptions for Veles&#39;</span>
</span></code></pre></div></figure>


<p>My patchset now has an additional patch in it:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>┌─<span class="o">[</span>Veles ~/Build/dwm<span class="o">]</span>
</span><span class='line'>└─╼ hg qseries
</span><span class='line'>setup.makefile
</span><span class='line'>base.config.customizations
</span><span class='line'>statuscolours
</span><span class='line'>cycle
</span><span class='line'>push
</span><span class='line'>bstack
</span><span class='line'>centurion.config
</span><span class='line'>veles.config
</span></code></pre></div></figure>


<p>This is where guards come in to play. If I wasn&#8217;t interested in sharing
the patchset, it would just be a matter of deleting the patch for Centurion.
However, what I want to do is direct MQ to ignore that specific patch
when applying the queue. I do that by creating a negative guard and then
activating it:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>hg qguard centurion.config -- -block
</span><span class='line'>hg qselect block
</span><span class='line'>number of unguarded, unapplied patches has changed from 8 to 7
</span></code></pre></div></figure>


<p>That&#8217;s it! Adding a verbose flag to <code>hg qseries</code><sup>2</sup> will print out the
patchset and the accompanying guard status:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>┌─<span class="o">[</span>Veles ~/Build/dwm<span class="o">]</span>
</span><span class='line'>└─╼ hg qseries -v
</span><span class='line'>0 U setup.makefile
</span><span class='line'>1 U base.config.customizations
</span><span class='line'>2 U statuscolours
</span><span class='line'>3 U cycle
</span><span class='line'>4 U push
</span><span class='line'>5 U bstack
</span><span class='line'>6 G centurion.config
</span><span class='line'>7 U veles.config
</span></code></pre></div></figure>


<p>The real test, of course, is pushing the patchset onto the fresh
dwm code:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>┌─<span class="o">[</span>Veles ~/Build/dwm<span class="o">]</span>
</span><span class='line'>└─╼ hg qpush -a
</span><span class='line'>applying setup.makefile
</span><span class='line'>applying base.config.customizations
</span><span class='line'>applying statuscolours
</span><span class='line'>applying cycle
</span><span class='line'>applying push
</span><span class='line'>applying bstack
</span><span class='line'>skipping centurion.config - guarded by <span class="s1">&#39;-block&#39;</span>
</span><span class='line'>applying veles.config
</span><span class='line'>now at: veles.config
</span></code></pre></div></figure>


<p>How cool is that? One central patchset, applied conditionally depending
upon the machine you are using at the time.</p>

<h4>Notes</h4>

<ol>
<li>Any guards applied on other machines will be present in the newly
pulled <span class="file">series</span> file: these conflicts will need
to be manually merged…</li>
<li>The options for all of the <code>hg</code> commands can be read with
<code>hg -v help $command</code>. For those related to queues, just prepend
a <code>q</code> to <code>$command</code>.</li>
</ol>


<p>Creative Commons image on Flickr by
<a href="http://www.flickr.com/photos/alternatewords/4903560373/" title="On Guard on Flickr">Thorsten Becker</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Mercurial Queues]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/07/24/queues/"/>
    <updated>2012-07-24T19:18:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/07/24/queues</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/queue.jpg" title="'Queue image on Flickr'" >
Over the last week or so, I have finally gotten around to digging into the whole concept of
using
<a href="http://hgbook.red-bean.com/read/managing-change-with-mercurial-queues.html" title="Chapter on queues in the Mercurial book">Mercurial Queues</a>
to manage patches against an upstream project; in my case
<a href="http://dwm.suckless.org" title="The truly suckless window manager…">dwm</a>.<sup>1</sup>
Essentially, this mercurial extension helps you manage a stack of patches on
top of a directory tree. This gives you quite a lot of fine-grained control
over your patchset and assists immeasurably with automating the application of
patches when the underlying codebase changes.</p>

<p>After having played around with queues for the last couple of days, I am quite
impressed: both the concept and the execution are simple and powerful. The concept
of Mercurial Queues is best described in the Mercurial book: the aptly titled,
<em>Mercurial: The Definitive Guide</em>:<sup>2</sup></p>

<blockquote><p>MQ&#8217;s marriage of distributed revision control with patches makes it much easier to isolate your work. Your patches live on top of normal revision history, and you can make them disappear or reappear at will. If you don&#8217;t like a patch, you can drop it. If a patch isn&#8217;t quite as you want it to be, simply fix it—as many times as you need to, until you have refined it into the form you desire.</p><footer><strong>Mercurial, The Definitive Guide</strong> <cite><a href='http://hgbook.red-bean.com/read/managing-change-with-mercurial-queues.html'>hgbook.red-bean.com/read/&hellip;</a></cite></footer></blockquote>


<p>I followed Filippo Negroni&#8217;s excellent
<a href="http://dwm.suckless.org/customisation/patch_queue" title="Step-by-step guide">tutorial on the dwm site</a>
to setup my own
<a href="http://pikacode.com/jasonwryan/dwm-patchset/files/default" title="Patchset on Pikacode">dwm patchset</a>
based on
<a href="http://hg.suckless.org/dwm" title="dwm hg repository">tip</a>, and the process was
surprisingly straightforward; the only caveat being it is a good idea to plan
quite carefully what changes you want in each particular patch. Once I had
completed the setup, it got me thinking about the fact that the final install
is done without <code>pacman</code>, just using <code>make install</code>. And, as a proof-of-concept
more than anything else, I wondered whether this functionality could be used
with <code>makepkg</code>.<sup>3</sup></p>

<p>Turns out, as you might expect with Arch, it was not much of a job to set it
up at all.</p>

<p><strong>Note</strong>: this doesn&#8217;t mean I think it is a good idea; I was just interested
to see <em>if</em> it could be done and <em>how</em> it would work once it was set up. For something
like dwm, this is definitely a case of introducing a huge amount of complexity for
no apparent benefit (for those people running Gnome, this may quite appeal to you…).</p>

<p>I have a
<a href="http://pikacode.com/jasonwryan/Centurion/file/default/Build/dwm-hg/PKGBUILD" title="If you must…">working PKGBUILD</a>
that you can use if you want to follow along at home. Once you have downloaded
it into <span class="file">dwm-hg/</span>, run <code>makepkg</code> to clone the dwm
repository and build the binary.  Then you need to make sure that the mercurial
queue extension is enabled, so your <span class="file">.hgrc</span> needs to
contain:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="o">[</span>extensions<span class="o">]</span>
</span><span class='line'>hgext.mq <span class="o">=</span>
</span></code></pre></div></figure>


<p>Now, you need to setup the queue repository. We do this in <code>$srcdir</code>, which
is <span class="file">dwm-hg/src/dwm</span>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>hg qinit -c
</span></code></pre></div></figure>


<p>The next step is to start applying the various patches that you want to comprise
your patchset on dwm. In my case that is base customizations to <span class="file">config.def.h</span>
and three other patches:
<a href="http://pikacode.com/jasonwryan/dwm-patchset/file/default/statuscolours" title="Patch in mercurial queue">statuscolours</a>,
<a href="http://pikacode.com/jasonwryan/dwm-patchset/file/default/cycle" title="ditto">cycle</a>, and
<a href="http://pikacode.com/jasonwryan/dwm-patchset/file/default/push" title="etc…">push</a>.
There are other patches in my repository, one of which patches the appropriate
settings for an Arch build in the
<a href="http://pikacode.com/jasonwryan/dwm-patchset/file/default/setup.makefile" title="Arch settings for Makefiles">relevant makefiles</a>.
This is taken care of by the PKGBUILD in this case.</p>

<p>From here, it is very much as Filippo describes it in his tutorial: make
some changes, add them to the queue and rinse and repeat:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>hg qnew base.customizations
</span><span class='line'> <span class="c"># “hack hack hack…”</span>
</span><span class='line'>hg qrefresh
</span><span class='line'>hg qcommit -m <span class="s1">&#39;Added changes to config.def.h to customize&#39;</span>
</span></code></pre></div></figure>


<p>After committing each of your changes as a discrete patch, you can review the queue
with <code>hg qseries</code>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>┌─<span class="o">[</span>Centurion ~/Build/dwm-hg/src/dwm<span class="o">]</span>
</span><span class='line'>└─╼ hg qseries
</span><span class='line'>config.customizations
</span><span class='line'>statuscolours
</span><span class='line'>cycle
</span><span class='line'>push
</span></code></pre></div></figure>


<p>And <code>hg qapplied</code> will tell you which of the patches is currently
applied in the working repository; at this stage the list should look
the same as that in <code>hg qseries</code>. The next step is to remove all of the
patches from the queue so that we have a clean repository:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>┌─<span class="o">[</span>Centurion ~/Build/dwm-hg/src/dwm<span class="o">]</span>
</span><span class='line'>└─╼ hg qpop -a
</span><span class='line'>popping push
</span><span class='line'>popping cycle
</span><span class='line'>popping statuscolours
</span><span class='line'>popping config.customizations
</span><span class='line'>patch queue now empty
</span></code></pre></div></figure>


<p>Should you need to edit a patch, it is simply a matter of popping
to that spot in the stack (you can do so by name or by index
number, beginning at 0):</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>┌─<span class="o">[</span>Centurion ~/Build/dwm-hg/src/dwm<span class="o">]</span>
</span><span class='line'>└─╼ hg qpop config.customizations
</span><span class='line'>popping push
</span><span class='line'>popping cycle
</span><span class='line'>popping statuscolours
</span><span class='line'>now at: config.customizations
</span><span class='line'> <span class="c"># “hack hack hack…”</span>
</span><span class='line'>hg qrefresh
</span><span class='line'>hg qpush -a
</span></code></pre></div></figure>


<p>Once you are satisfied with the state of the stack, remove all of the
patches to return to the original clean working directory and <code>cd</code> back
to <span class="file">dwm-hg/</span>. You can now use <code>makepkg -fi</code> to
rebuild the package and you should see the pushed patches as part of
the output:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="o">==</span>&gt; Starting build<span class="o">()</span>...
</span><span class='line'><span class="o">==</span>&gt; Pushing queued patchset
</span><span class='line'>applying config.customizations
</span><span class='line'>applying statuscolours
</span><span class='line'>applying cycle
</span><span class='line'>applying push
</span><span class='line'>now at: push
</span><span class='line'>dwm build options:
</span></code></pre></div></figure>


<p>…and when you restart dwm, your customizations will be applied.
When new changes are pushed to
<a href="http://hg.suckless.org/dwm" title="dwm mercurial repo">the dwm repo</a>
you can just <code>makepkg -fi</code>, and, if any of the patches fail due
to changes in the underlying code, pop the stack to the failed
patch, rebase the code, <code>hg qrefresh</code> and continue until done.</p>

<p>As I said at the beginning of this post, this isn&#8217;t a particularly smart way to
use Mercurial Queues, PKGBUILDs or a combination of the two. You are much
better off just cloning dwm to your local repository, initializing a queue
repository and, once you are done setting up your patchset, issuing <code>make &amp;&amp;
sudo make install</code>.</p>

<p>If you have more than one machine, you can easily setup a repository for
your patchset on
<a href="https://bitbucket.org/" title="bitbucket free mercurial hosting">bitbucket</a>
or <a href="http://pikacode.com/" title="Free Mercurial and Git hosting">Pikacode</a>
and host it there: then just pull the patchset queue
from your other boxes and <code>hg qpush -a</code>. If you require a slightly
different patchset for each box, you can use MQ to manage this
process as well. This is where MQ really excels;
I&#8217;ll cover this in more detail in my next post.</p>

<h4>Notes</h4>

<ol>
<li>See <a href="http://jasonwryan.com/blog/categories/dwm/" title="dwm category in the archives">related dwm posts</a>.</li>
<li>I can&#8217;t recommend this {book,wiki} highly enough; it is an excellent
example of thorough, accessible documentation.</li>
<li>In the case of something like dwm, this is really irrelevant, as there
is a single tiny binary and a <code>man</code> page, so keeping track of these files on
your system is not an issue at all.</li>
</ol>


<p>Flickr Creative Commons image by
<a href="http://www.flickr.com/photos/bagelmouse/3936852444/" title="Queue image on Flickr">RachelH</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The Myth of Breakage]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/07/19/breakage/"/>
    <updated>2012-07-19T19:23:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/07/19/breakage</id>
    <content type="html"><![CDATA[<p><img class="left" src="https://dl.dropbox.com/u/261312/Blog-images/broken.jpg" title="Image of breakage on Flickr" >
Breakage is one of the memes of the Arch Linux community; it is referenced frequently on the
<a href="https://bbs.archlinux.org/" title="Arch Linux BBS">Arch boards</a> and in the various
<a href="https://wiki.archlinux.org/index.php/IRC_Channels" title="Wiki page listing channels">IRC channels</a>.
It doesn&#8217;t take newcomers long to realize that, whether something is actually broken or not,
there is always
<a href="http://allanmcrae.com/category/arch-linux/" title="Allan's Blog">someone they can blame</a>.<sup>1</sup></p>

<p>My experience of Arch, over the last three and a bit years, is quite the opposite. I have yet to
experience anything that would qualify as breakage. Sure, there have been bugs, mostly upstream,
and the more frequent moments where I haven&#8217;t been as diligent as I should, but not once have I
had a machine that was unbootable or otherwise unusable. Arch has, on both my home and work
machines, been incredibly stable and reliable.</p>

<p>For a number of Arch Linux users, however, that was not their experience over the last week when
<a href="http://www.archlinux.org/news/the-lib-directory-becomes-a-symlink/" title="News item on the move">/lib was moved to /usr/lib</a>.
The volume of people on the boards and on IRC reporting unbootable or unusable systems was
remarkable. Remarkable because, despite the fact that the
<a href="http://www.archlinux.org/news/the-lib-directory-becomes-a-symlink/" title="Once more, just in case…">news item</a>, the
<a href="http://www.archlinux.org/news/the-lib-directory-becomes-a-symlink/" title="Arch wiki page on the change">wiki page</a>,
and the <a href="http://mailman.archlinux.org/pipermail/arch-announce/2012-July/000317.html" title="Mail archive">email to arch-announce</a>
all <em>explicitly</em> warned people not to use the <code>--force</code> option,<sup>2</sup> so many did.</p>

<p><span class='pullquote-right' data-pullquote='90% of the breakage was because people either didn&#8217;t see, or disregarded, that advice. '>
Sadly, these red-boxed warnings were apparently not enough.
90% of the breakage was because people either didn&#8217;t see, or disregarded, that advice.
The remaining 10% were either in a hurry and didn&#8217;t pay close attention to how
to deal with any leftover files in <span class="file">/lib</span> or <code>rm -rf</code>&#8216;ed
in the wrong directory.
<a href="http://www.gnu.org/fun/jokes/shit-happens.html" title="GNU Humour…">Accidents happen</a>.
</span></p>

<p>What I am interested in is the people who fell into the much larger category,
and principally those that didn&#8217;t see any of the communications about this
change in advance of updating and reasoned, based on a recent change that did
<a href="http://www.archlinux.org/news/filesystem-upgrade-manual-intervention-required-1/" title="News item on filesystem upgrade">require the use of &#8211;force</a>,
that this was the most expedient way to resolve <code>pacman</code> reporting conflicting
files.</p>

<p>Some context. The <code>glibc</code> update was released to the
<a href="https://wiki.archlinux.org/index.php/Testing#.5Btesting.5D" title="Wiki entry on Testing">[testing] repository</a>
in the first week of July: and there were a couple of long threads<sup>3</sup>
about issues and fixes before it was pushed to [core]. By the time the
package was released for general consumption, it had been tested and the
developers had obviously planned how to make what is a fundamental system
change with a minimal amount of user intervention.  I think that, given the
magnitude of the challenge, they did a superb job.</p>

<p>How then did it go so wrong for so many?<sup>4</sup> To answer that, you have
to consider the nature of Arch. It&#8217;s <em>not</em> the sort of distribution where you
install it and then just go on your merry way, installing
<a href="http://oswatershed.org/" title="It's SCIENCE, Jim">the least obsolete packages</a>,
revelling in the speed of the package manager and generally being
a 1337 h@x0r…</p>

<p>Successfully running a rolling release like Arch, irrespective of your level of
competence, means staying in touch with what is happening—in
<a href="http://kmkeen.com/pacmatic/" title="Pacman wrapper that pulls news updates">some form or other</a>.
Subscribing to the arch-general <acronym title="Mailing list">ML</acronym>,
visiting the forums, idling in IRC; somehow remaining connected to what is
going on in the community so that you don&#8217;t blindly update one day and wonder
why your system is broken.</p>

<p>This strikes me as a real strength; by design Arch encourages its users to
participate in the community. Even if you are only lurking, over time you will
inevitably find yourself posting in a thread, responding to an email, editing
the wiki,
<a href="http://jasonwryan.com/blog/2012/03/09/aurphan/" title="Post on aurphan">adopting an orphaned package</a>—increasingly
getting involved and contributing.</p>

<p>This level of involvement is not for everyone. Some may find it onerous or
a waste of their time. That&#8217;s fine. There are any number of other distros
that do not ask for this level of commitment. The <em>quid pro quo</em> for
running Arch, though, is that you are prepared, in whatever shape or form
best works for you, to give something back; at the very least, that is your
attention.</p>

<h4>Notes</h4>

<ol>
<li>This is, of course, a reference to said Arch meme: Allan is one
of the developers who has contributed an enormous amount to Arch and the fact
that his IRC nick is <code>allanbrokeit</code> is purely coincidental.</li>
<li>At the end of 2011, the short option <code>-f</code>
<a href="http://mailman.archlinux.org/pipermail/pacman-dev/2011-October/014589.html" title="Post to ML anouncing change">was removed</a>
from <code>pacman</code> so “it at least makes people read the word &#8216;force&#8217; and maybe they
will have some sense to step back and think about what they are doing first.”</li>
<li><a href="https://bbs.archlinux.org/viewtopic.php?id=144620">https://bbs.archlinux.org/viewtopic.php?id=144620</a> and
<a href="https://bbs.archlinux.org/viewtopic.php?id=144616">https://bbs.archlinux.org/viewtopic.php?id=144616</a></li>
<li>Relatively speaking. In situations like this, the overwhelming amount of traffic
is about what went wrong, not people posting to say they had no difficulties whatsoever…</li>
</ol>


<p>Creative Commons image on Flickr from
<a href="http://www.flickr.com/photos/daviddoctorrose/431786001/" title="Broken keyboard on Flickr">djeucalyptus</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Replacing Grub With Syslinux]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/07/09/syslinux/"/>
    <updated>2012-07-09T13:51:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/07/09/syslinux</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/grub.jpg" title="Image of grub on Flickr" >
With the announcement late last month that
<a href="http://lists.gnu.org/archive/html/grub-devel/2012-06/msg00093.html" title="Grub ML announcement">Grub 2.00 has been released</a>
I thought that it was time to stop procrastinating and do something about moving away from
<a href="http://www.gnu.org/software/grub/grub-legacy.html" title="Gnu Page for Grub Legacy">Grub Legacy</a>,
which is no longer actively developed. Not that there is anything wrong with Grub Legacy&#8217;s
functionality; it has always done whatever I asked of it (admittedly, not a lot) and done so
without complaint.</p>

<p>I have used Grub2 before, when I was running Ubuntu on my home desktop, and it is the bootloader
on my Debian Squeeze server. I can&#8217;t, however, say that I have ever really understood—or
appreciated—its mutliple file, “need to reconfigure after making any changes” type of
complexity. So, I thought that I would give
<a href="http://www.syslinux.org/wiki/index.php/The_Syslinux_Project" title="Syslinux Wiki">Syslinux</a>
a shot.</p>

<p>Syslinux isn&#8217;t a single bootloader, rather it is a collection of lightweight bootloaders,
with <a href="http://www.syslinux.org/wiki/index.php/EXTLINUX" title="Extlinux page on Syslinux Wiki">Extlinux</a>
responsible for booting ext2, ext3, ext4 and btrfs filesystems. As the
<a href="https://wiki.archlinux.org/index.php/Syslinux" title="The FINE Wiki">Arch Wiki Syslinux page</a>
notes, since Syslinux 4, Extlinux has been merged with Syslinux.</p>

<p>Installing Syslinux is <em>ridiculously</em> easy. It is literally a five step process. First,
install the package:</p>

<figure class='code'><div class="highlight"><pre><code class=''><span class='line'>pacman -S syslinux</span></code></pre></div></figure>


<p>After installing <code>syslinux</code> pacman will helpfully tell you what to do next:</p>

<blockquote><p>==> If you want to use syslinux as your bootloader<br/>==> edit /boot/syslinux/syslinux.cfg and run<br/>==>   # /usr/sbin/syslinux-install_update -i -a -m<br/>==> to install it.</p></blockquote>


<p>Arch user <a href="http://pyther.net/" title="Matthew's website">Matthew Gyurgyik</a> has written an
ingenious script, <code>syslinux-install_update</code> that automates the process of writing the
<acronym title="Master Boot Record">MBR</acronym> and installing the relevant files to
<span class="file">/boot/syslinux/</span>. The script also checks if, as is the case
with my desktop, there is a RAID array present, and if so passes the install command the
<code>--raid</code> flag:</p>

<blockquote><p>RAID mode.  If boot fails, tell the BIOS to boot the next device in the boot sequence (usually the next  hard<br/>disk) instead of stopping with an error message.  This is useful for RAID-1 booting.</p></blockquote>


<p>After running the script, you should receive a message advising you that Syslinux
has been sucessfully installed on both drives:</p>

<blockquote><p>Detected RAID on /boot - installing Syslinux with &#8211;raid<br/>Syslinux install successful<br/>Boot Flag Set - /dev/sda1<br/>Boot Flag Set - /dev/sdb1<br/>Installed MBR (/usr/lib/syslinux/mbr.bin) to /dev/sda<br/>Installed MBR (/usr/lib/syslinux/mbr.bin) to /dev/sdb</p></blockquote>


<p>If you are moving from Grub Legacy, configuring Syslinux is similarly painless.
There are two sections to a basic  <span class="file">/boot/syslinux/syslinux.cfg</span>,
the defaults and the prompt entries.</p>

<p>I set up my defaults to be essentially invisible:</p>

<figure class='code'><div class="highlight"><pre><code class=''><span class='line'># General settings
</span><span class='line'>DEFAULT Arch
</span><span class='line'>PROMPT 0
</span><span class='line'>TIMEOUT 0</span></code></pre></div></figure>


<p>And then copy across the relevant lines from my <span class="file">/boot/grub/menu.lst</span>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>grep <span class="nv">root</span><span class="o">=</span> /boot/grub/menu.lst &gt;&gt; /boot/syslinux/syslinux.cfg
</span></code></pre></div></figure>


<p>Then it is just a matter of adding the relevant entries under LABEL:</p>

<figure class='code'><div class="highlight"><pre><code class=''><span class='line'>LABEL Arch
</span><span class='line'>   MENU LABEL Arch Linux
</span><span class='line'>   LINUX ../vmlinuz-linux
</span><span class='line'>   APPEND root=/dev/mapper/vgroup-lvroot cryptdevice=/dev/md1:vgroup ro
</span><span class='line'>   INITRD ../initramfs-linux.img</span></code></pre></div></figure>


<p>You then add entries for Fallback, and any other images that you may wish to
boot from.</p>

<p>And that, in their entirety, is steps two and three. You then move to steps four and five:</p>

<figure class='code'><div class="highlight"><pre><code class=''><span class='line'>pacman -Rsn grub
</span><span class='line'>shutdown -r now</span></code></pre></div></figure>


<p>And you reboot with Syslinux. Done.</p>

<p>The beauty of Syslinux, from my perspective, is that it is simple to install
and configure, with just the one config file and the options all well documented
and easy to understand. If you want a menu with a background
image, you can have that. If, like me, you just want to get on and boot your default,
it does that.</p>

<p>Additionally, if you want or need to boot into Fallback, or want to dual boot,
you can just hold down <kbd>Shift</kbd> at boot time and enter the desired
Label at the prompt. Syslinux has Tab completion, so you only need enter a
couple of letters, hit <kbd>Tab</kbd> and you will see all of the available
Labels to boot. Brilliant.</p>

<h4>Notes</h4>

<p>Creative Commons Flickr image by
<a href="http://www.flickr.com/photos/sgodt/5103674184/">custer_fluck</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Misunderstanding Arch]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/06/16/misunderstanding/"/>
    <updated>2012-06-16T10:52:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/06/16/misunderstanding</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/hands.jpg" title="'mutt logo'" ></p>

<p>I am frequently struck by how many people arrive on the
<a href="https://bbs.archlinux.org/" title="Arch Linux Forums">Arch boards</a> without <em>any</em>
understanding of how Arch is different from the other GNU/Linux communities
they may have spent time with (if, indeed, they have spent any time in
another community before trying Arch). For me, this is akin to arriving in a
foreign country and not bothering to familiarize yourself at all with the local
mores and customs; it lies on a spectrum somewhere between ignorance and
outright arrogance.</p>

<p>The result, inevitably, is that these people are shocked
when their expectations of how they <em>should</em> be treated are at odds with the
reception their behaviour invites…</p>

<p>Before venturing any further, I should preface my remarks about this with
something of a disclaimer. These are my own views and not those of the current,
or past, forum staff.</p>

<p>One of Arch&#8217;s significant acheivements is the quality of
<a href="https://wiki.archlinux.org" title="THE best GNU/Linux Wiki">its documentation</a>.
Not just the technical documentation describing how to install and configure
Arch, but the cultural documentation that sets out
<a href="https://wiki.archlinux.org/index.php/The_Arch_Way" title="The Arch Way">Arch&#8217;s philosophy</a>
and <a href="https://wiki.archlinux.org/index.php/Forum_Etiquette" title="Forum Etiquette">standards of behaviour</a>. Both these pages provide clear statements on what to expect when
using Arch Linux and a clear indication of how to respectfully interact with the
community when you are seeking help.</p>

<p>The defining statement about Arch&#8217;s intended user base is quite direct and
unambiguous:</p>

<blockquote><p>Arch Linux targets and accommodates competent GNU/Linux users <br/>by giving them complete control and responsibility over the system.</p><footer><strong>The Arch Way</strong> <cite><a href='https://wiki.archlinux.org/index.php/The_Arch_Way#User-centric'>wiki.archlinux.org/index.php/&hellip;</a></cite></footer></blockquote>


<p>The expression “targets and accommodates” doesn&#8217;t exclude other users—for
example, those that are not necessarily competent, but are wanting to learn
more about the specifics of how their machines work—it does, however, signal
quite explicitly what sort of community Arch is. And what it is not.</p>

<p><a href="http://ubuntu.com" title="Ubuntu Linux">Ubuntu</a> is an excellent distribution. Like Arch,
it has very specific aims and a clear concept of what the Ubuntu community is.
Popularity is central to Ubuntu&#8217;s culture. People coming from Ubuntu, who
haven&#8217;t bothered to familiarize themselves with Arch&#8217;s values, often struggle
to appreciate the difference; leading to comments like this one:</p>

<blockquote><p>Maybe if Arch is friendly and Arch forum is friendly, it might go some<br/>place, who knows…</p><footer><strong>Linux Journal commenter</strong> <cite><a href='http://www.linuxjournal.com/content/arch-way#comment-361974'>www.linuxjournal.com/content/&hellip;</a></cite></footer></blockquote>


<p>This was posted in reply to a post on Arch in which the author noted how to
seek help with Arch Linux:</p>

<blockquote><p>You&#8217;ll find far less hand-holding on the Arch Forums than some of the other<br/>distro&#8217;s forums, and for good reason.  Arch has one of the most informative,<br/>user-friendly wiki&#8217;s out there. Do not, I repeat, DO NOT ask a question in the<br/>forums or on IRC without searching the wiki and the forums first.</p></blockquote>


<p>Similarly, looking through the threads in
<a href="https://bbs.archlinux.org/viewforum.php?id=23" title="Newbie board">Newbie Corner</a>
will periodically turn up new posters who are indignant at being told to
<acronym title="Read The Fscking Manual">RTFM</acronym> and see it as some
sort of <em>personal</em> attack, when in fact it is just someone pointing out the
obvious to them. The community hasn&#8217;t compiled all that documentation just
so they can sit around and regurgitate answers for people who are either
unwilling or incapable of making the minimum amount of  effort required to
solve their own problems…</p>

<p>If you want handholding, there are plenty of online communities that will
cater for you. If you install Arch and think that you are automatically entitled
to immediate support for issues that you encounter, then you are mistaken.
If you think that Arch will suffer if you don&#8217;t get what you want, then
your problems extend significantly beyond your choice of distro.</p>

<p>The community has worked hard over the years to keep the signal-to-noise ratio
on the boards high, that way, the forums remain a helpful resource for the community,
not a breeding ground for
<a href="http://jasonwryan.com/blog/2012/03/17/vampires/" title="Post on parasites…">help vampires</a>.</p>

<h4>Notes</h4>

<p>Flickr Creative Commons image by
<a href="http://www.flickr.com/photos/angellic/47031159/">si_si_ay</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using Notmuch with mutt]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/05/23/notmuch/"/>
    <updated>2012-05-23T19:37:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/05/23/notmuch</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/magnifier.png" title="day 307 on Flickr" >
Seeing as I have been focussing on my mail client, I thought I would round out the trifecta of
<a href="http://www.mutt.org/" title="mutt homepage">mutt</a> posts<sup>1</sup> with what I am assuming is the
final piece of the puzzle: searching <code>mutt's</code> maildirs. For a small to average size mailbox, <code>mutt's</code>
searching works fine, but as your mail volume grows this simple search doesn&#8217;t really scale. That&#8217;s
where the rather modestly named <a href="http://notmuchmail.org/" title="Notmuch website">Notmuch</a> comes into play.</p>

<p>It can be run as a standalone mail client, but you can also use it with <code>mutt</code> to provide
a ruthlessly efficient and fast search tool for your email. I had looked at it and
<a href="http://sup.rubyforge.org/" title="A console client for people with lots of mail">Sup</a>
a couple of years ago, but was spurred to do something about it this week when
<a href="https://twitter.com/#!/chosig" title="Chosig on Twitter">Gunnar Lundström</a> pinged me on twitter and
suggested I check it out. So I did.</p>

<blockquote><p>&#8220;Not much mail&#8221; is what Notmuch thinks about your email collection. Even if you receive 12000 <br/>messages per month or have on the order of  millions of messages that you&#8217;ve been saving for decades. <br/>Regardless, Notmuch will be able to quickly search all of it. It&#8217;s just plain not much mail.</p><footer><strong>Notmuch website</strong> <cite><a href='http://notmuchmail.org'>notmuchmail.org/&hellip;</a></cite></footer></blockquote>


<p>There was previously a
<a href="http://upsilon.cc/~zack/blog/posts/2011/01/how_to_use_Notmuch_with_Mutt/">mutt-notmuch script</a>
for integrating the two, but the functionality was included upstream at the start of this year
so it is quite straightforward to set it up. There is a
<a href="http://aur.archlinux.org/packages.php?ID=36289" title="Arch User Repository package">package in the AUR</a>
but it is intended as the full mail client, complete with, <em>shudder</em>, emacs support amongst
other things. I have stripped out the uneeded bindings and included the relevant <code>perl</code> libraries in a
<a href="https://bitbucket.org/jasonwryan/centurion/src/6ff0f252961f/Build/notmuch/PKGBUILD" title="…in my bitbucket repo">modified PKGBUILD</a>
if you just want the basic search with <code>mutt</code>.</p>

<p>Otherwise, you&#8217;ll need to step through it manually.</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>pacman -S perl perl-mailtools perl-mail-box perl-string-shellquote
</span><span class='line'>cowerd notmuch perl-term-readline-gnu
</span></code></pre></div></figure>


<p>As you will see from the PKGBUILD, you will need to copy the <code>notmuch-mutt</code> script
into your <code>$PATH</code>: you&#8217;ll find it in <span class="file">contrib/notmuch-mutt/</span>.</p>

<p>There is a simple interative setup, which you can complete before running the index the first time:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>notmuch setup
</span><span class='line'>notmuch new
</span></code></pre></div></figure>


<p>The final step is to copy across the <code>mutt</code> macros included with the script:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>cat src/notmuch-0.13/contrib/notmuch-mutt/notmuch-mutt.rc &gt;&gt; <span class="nv">$HOME</span>/.mutt/muttrc
</span></code></pre></div></figure>


<p>Now, from within <code>mutt</code>, <kbd>F8</kbd>, <kbd>F9</kbd> and <kbd>F6</kbd> will respectively
search, create the relevant threads from search results, and tag mails with <code>notmuch</code>.</p>

<p>As I use <code>offlineimap</code> to retrieve my mail, I simply added <code>notmuch new</code> to the script that
runs as a <code>cron</code> job to synch my mail and <code>notmuch</code> reindexes all of my mail as soon as it arrives.</p>

<h3>Updated 27/5/12</h3>

<p>Two of the <code>mutt</code> macros that are shipped in <span class="file">contrib/notmuch-mutt/notmuch-mutt.rc</span>
do not work. I have written a patch to fix this and
<a href="http://notmuchmail.org/pipermail/notmuch/2012/011263.html" title="Patch on notmuch list">posted it to the ML</a>.</p>

<h4>Notes</h4>

<ol>
<li><a href="http://jasonwryan.com/blog/2012/04/21/lbdb/">Using mutt, LDAP and SSL</a> and
<a href="http://jasonwryan.com/blog/2012/05/12/mutt/">mutt and HTML email</a></li>
</ol>


<p>Creative Commons image by
<a href="http://www.flickr.com/photos/mjtmail/3008566512/in/photostream/">mjtmail on Flickr</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[mutt and HTML email]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/05/12/mutt/"/>
    <updated>2012-05-12T15:49:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/05/12/mutt</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/mutt-1.png" title="'mutt logo'" ></p>

<p>Following on from my <a href="http://jasonwryan.com/blog/2012/04/21/lbdb/" title="Using mutt, LDAP and SSL">last post about mutt</a>,
I have been tinkering more with the most suckless of mail clients to
get it to deal with—of all things—<acronym title="HyperText Markup Language">HTML</acronym>
emails. I will preface this post with a remark or two that amounts to a warning about
intemperate language, ranting and a generally cranky disposition: repeated contact with
email marketers can do that to you…</p>

<p>A further  brief digression is warranted here. HTML email is, without doubt,
evidence of the imminent end of civilized life as we know it; much like the
<a href="http://en.wikipedia.org/wiki/Places_in_The_Hitchhiker's_Guide_to_the_Galaxy#Golgafrincham" title="Wikipedia entry on HHGTTG">Golgafrincham diaspora</a>, it is attributable to a depraved cabal of marketing consultants
and provides the same level of social good as syphilis and fistulas. Suffice to say, it is a blight.</p>

<p>Sadly, it is a blight that I have to deal with. Up until now, I had done that by using the
excellent <a href="http://w3m.sourceforge.net/" title="w3m homepage on sourceforge">w3m</a> to render
HTML as text in mutt itself. That is accomplished easily enough with an entry in
<span class="file">muttrc</span> and another in a <span class="file">mailcap</span> file.</p>

<figure class='code'><figcaption><span>~/.mutt/muttrc </span></figcaption>
 <div class="highlight"><pre><code class='sh'><span class='line'>auto_view text/html                                      <span class="c"># view html automatically</span>
</span><span class='line'>alternative_order text/plain text/enriched text/html     <span class="c"># save html for last</span>
</span></code></pre></div></figure>




<figure class='code'><figcaption><span>~/.mutt/mailcap </span></figcaption>
 <div class="highlight"><pre><code class='sh'><span class='line'>text/html; w3m -I %<span class="o">{</span>charset<span class="o">}</span> -T text/html; copiousoutput;
</span></code></pre></div></figure>


<p>This works for 80 percent of the HTML email I get. It is enough to confirm that the mail is useless
and can be discarded. The other 20 percent, however, is slightly more problematic. The initial
view in w3m is enough to tell me that, due to the outstanding incompetence of the idiots that
generated the email, there <em>is</em> actually some information that is contained in the email that I need
to access <strong>but it is not viewable in a text browser.</strong></p>

<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/mutt-2.png" title="'An example…'" ></p>

<p>For this special level of retardation, I need to be able to open the email in a graphical browser.
As I use vimprobable, that means sending the file to
<a href="http://jasonwryan.com/blog/2011/06/26/using-vimprobable/" title="My post on Using vimprobable">vimprobable running in tabbed</a>. Fortunately, as you would expect with superior software,
<code>mutt</code> has a way of handling this gracefully. In mutt&#8217;s extensive documentation, there is a
<a href="http://www.mutt.org/doc/manual/manual-5.html" title="Go and read it…">page on mutt&#8217;s MIME support</a>
that details how to set up a graduated response to this pernicious issue:</p>

<blockquote><p>In addition, you can use this with Autoview to denote two commands for viewing<br/>an attachment, one to be viewed automatically, the other to be viewed<br/>interactively from the attachment menu.</p><footer><strong>mutt manual</strong> <cite><a href='http://www.mutt.org/doc/manual/manual-5.html'>www.mutt.org/doc/manual/&hellip;</a></cite></footer></blockquote>


<p>So, you can have <code>mutt</code> render the HTML abomination in <code>w3m</code> in most cases, and when those
instances of particularly cretinous behaviour make it to your inbox, you can choose to
view them in your web browser. In my case, by altering the <span class="file">mailcap</span>
entry to look like this:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>text/html; vimprobtab.sh %s &amp;; <span class="nb">test</span><span class="o">=</span><span class="nb">test</span> -n <span class="s2">&quot;$DISPLAY&quot;</span>; needsterminal;
</span><span class='line'>text/html; w3m -I %<span class="o">{</span>charset<span class="o">}</span> -T text/html; copiousoutput;
</span></code></pre></div></figure>


<p>The first entry tests that X is running, and if it is, it hands the file to <code>vimprobable</code>. The
default, however, is determined by the <code>copiousoutput</code> tag. So, in <code>mutt</code> it is just a matter
of hitting <kbd>v</kbd> to view the attached HTML and then <kbd>m</kbd> to send it to <code>mailcap</code>.
For convenience, I bind <kbd>Enter</kbd> to that function in <span class="file">muttrc</span>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nb">bind </span>attach &lt;<span class="k">return</span>&gt;    view-mailcap
</span></code></pre></div></figure>



]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Using mutt, LDAP and SSL]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/04/21/lbdb/"/>
    <updated>2012-04-21T11:23:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/04/21/lbdb</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/addressbook.png" title="'Address Book Icon by bertop on Flickr'" ></p>

<p>One of the great things about starting a new job at
<a href="http://jasonwryan.com/blog/2012/04/05/catalyst/" title="My post on joining Catalyst IT">an open source company</a>
is having the freedom to use the tools that suit your workflow, rather than
having to suffer the indignity of whatever the IT department consider to be the
lowest comon denominator. Suffice to say, I have had a lot of fun this week
setting up my working environment—and the ocassional hiccough as I was forced to learn
something new…</p>

<p>One of those “learning opportunities” consisted of trying to get my mail client,
<a href="http://www.mutt.org/" title="All mail clients suck. This one just sucks less.">mutt</a>
to talk to the <acronym title="Lightweight Directory Acces Protocol">LDAP</acronym>
directory over <acronym title="Secure Sockets Layer">SSL</acronym> so that I could
query the shared address book. There are a number of helpful blog posts that describe
using <a href="http://www.spinnaker.de/lbdb/" title="The Little Brother Database homepage">lbdb</a>
with <code>mutt</code><sup>1</sup>. Unfortunately, after a lot of searching, I was unable to find
any documentation on achieving this integration over a secure connection.
I kept seeing this error:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>Error: Search failed. LDAP server returned an error : 13, description: TLS
</span><span class='line'>confidentiality required at /usr/lib/mutt_ldap_query line 198, &lt;DATA&gt; line 558.
</span></code></pre></div></figure>


<p>Several hours later, and with some
help from <a href="https://twitter.com/#!/ibeardslee" title="Ian on Twitter: follow him…">@ibeardslee</a>,
I managed to set it up, and it was definitely worth the effort.</p>

<p>You will need to install <code>lbdb</code> from
<a href="http://aur.archlinux.org/packages.php?ID=10225" title="AUR package">the AUR</a>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>cowerd lbdb     <span class="c"># 2</span>
</span></code></pre></div></figure>


<p>…and a couple of packages from the repos to make it all work:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>pacman -S perl-ldap perl-io-socket-ssl netkit-bsd-finger
</span></code></pre></div></figure>


<p>Then it is a matter of configuring <code>lbdb</code> to both
query the LDAP directory and be able to be called from <code>mutt</code>.
First, copy the config files into your <span class="file">$HOME</span>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>mkdir .lbdb
</span><span class='line'>cp /etc/lbdb.rc .lbdb/lbdbrc
</span><span class='line'>cp /etc/lbdb_ldap.rc .lbdb/ldap.rc
</span></code></pre></div></figure>


<p>And then modify the two configuration files to suit your setup:
The first, <span class="file">$HOME/.lbdb/lbdbrc</span>, is well commented and
self-explanatory; add <code>ldap</code> to the methods and the
nickname of your server:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nv">METHODS</span><span class="o">=</span><span class="s2">&quot;m_abook m_ldap&quot;</span>
</span><span class='line'><span class="nv">LDAP_NICKS</span><span class="o">=</span><span class="s2">&quot;catalyst&quot;</span>
</span></code></pre></div></figure>


<p>The second config file, <span class="file">$HOME/.lbdb/ldap.rc</span>
is written in Perl and is a bit of a shocker:</p>

<figure class='code'> <div class="highlight"><pre><code class='perl'><span class='line'><span class="nv">%ldap_server_db</span> <span class="o">=</span> <span class="p">(</span>
</span><span class='line'>    <span class="s">&#39;catalyst&#39;</span> <span class="o">=&gt;</span> <span class="p">[</span><span class="s">&#39;ldaps://ldap.catalyst.net.nz:636&#39;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&#39;ou=Staff,ou=People,dc=catalyst,dc=net,dc=nz&#39;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&#39;givenname sn cn mail&#39;</span><span class="p">,</span> <span class="s">&#39;givenname sn cn mail&#39;</span><span class="p">,</span>
</span><span class='line'>                    <span class="s">&#39;${mail}&#39;</span><span class="p">,</span> <span class="s">&#39;${givenname} ${sn}&#39;</span><span class="p">]</span>
</span><span class='line'><span class="p">);</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># hostname of your ldap server</span>
</span><span class='line'><span class="nv">$ldap_server</span> <span class="o">=</span> <span class="s">&#39;ldaps://ldap.catalyst.net.nz:636&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$search_base</span> <span class="o">=</span> <span class="s">&#39;ou=Staff,ou=People,dc=catalyst,dc=net,dc=nz&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$ldap_search_fields</span>    <span class="o">=</span> <span class="s">&#39;givenname sn cn mail&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$ldap_expected_answers</span> <span class="o">=</span> <span class="s">&#39;givenname sn cn mail&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$ldap_result_email</span>     <span class="o">=</span> <span class="s">&#39;${mail}&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$ldap_result_realname</span>  <span class="o">=</span> <span class="s">&#39;${givenname} ${sn}&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$ignorant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span><span class='line'><span class="nv">$ldap_bind_dn</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="nv">$ldap_bind_password</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="p">;</span>
</span><span class='line'><span class="mi">1</span><span class="p">;</span>
</span></code></pre></div></figure>


<p>The key is to ensure that you use both the <code>ldaps</code>
prefix <strong>and</strong> explicitely specify the SSL port, 636. Without both of these, you will
get the TLS confidentiality error.</p>

<p>You can then test that it is working correctly by running a query:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>lbdbq jemima
</span></code></pre></div></figure>


<p>All going well, if there is indeed a Jemima in the shared address book, you will see her
contact details miraculously appear before you. If there is more than one, you will have a
list to choose from.</p>

<p>Finally, you just need to set up <code>mutt</code> to query <code>lbdb</code>.
In your <span class="file">muttrc</span>, add the following:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nb">set </span><span class="nv">query_command</span> <span class="o">=</span> <span class="s2">&quot;lbdbq %s 2&gt;/dev/null&quot;</span>
</span></code></pre></div></figure>


<p>I found that suppressing the errors made the whole experience a little smoother. You
may not require it… Now, hitting <kbd>Shift</kbd><kbd>q</kbd> in <code>mutt</code>
brings up a prompt to query the LDAP directory (and my <a href="http://abook.sourceforge.net/" title="abook homepage">abook</a> address book that I share via
<a href="https://www.dropbox.com/" title="Dropbox homepage">dropbox</a>). You can also access the directory
by starting to type an email address and then hitting <kbd>Ctrl</kbd><kbd>t</kbd> to see
a list of possible completions.</p>

<h4>Notes</h4>

<ol>
<li><a href="http://www.christianschenk.org/blog/integrating-ldap-into-mutt/" title="Integrating LDAP into Mutt">Christian Schenk&#8217;s post</a> got me started.</li>
<li>A <a href="https://bitbucket.org/jasonwryan/eeepc/src/f15bf6e51e62/Scripts/cowerd" title="Script in bitbucket repo">wrapper script for cower</a></li>
</ol>


<p>Creative Commons image <a href="http://www.flickr.com/photos/bertop/2530620838/">by bertop on Flickr</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[The Next Thing]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/04/05/catalyst/"/>
    <updated>2012-04-05T15:54:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/04/05/catalyst</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/change.jpg" title="'Climate Change by Swamibu on Flickr'" ></p>

<p>After eight years as a bureaucrat<sup>1</sup> working in a
<a href="http://ssc.govt.nz" title="State Services Commission website">central agency</a>
in New Zealand&#8217;s public service, I have hung up the grey cardigan.</p>

<p>While I am sure that I will never shed some of the qualities of being an
official (think discretion and a belief in the importance of sound
governance—rather than a keen ear for the rattle of the tea trolley),
I am looking forward to the opportunity to stretch out a little<sup>2</sup>.</p>

<p>When I first joined the Commission, it was to work in the E-government Unit. I
was strongly attracted to a role that combined communications and technology
and, at the time, the EGU was the epicentre of a huge amount of really interesting
initiatives. The
<a href="http://archive.ict.govt.nz/plone/archive/policy/open-source.1.html" title="Policy Paper in the egovernment archive">Open Source Policy</a>,
the <a href="http://archive.ict.govt.nz/plone/archive/services/authentication/library/docs/authentication-bpf/index.html" title="BPF in the egovernment archive">Authentication Framework</a>,
work on <a href="http://archive.ict.govt.nz/plone/archive/policy/tc-and-drm/oldindex.html" title="TC &amp; DRM paper in egovt archive">Digital Rights Management</a>
and <a href="http://archive.ict.govt.nz/plone/archive/policy/trust-security/niip-report.1.html" title="Security in the egovt archive">security</a>
to name just a few; it was a geek&#8217;s paradise (certainly from a policy perspective).</p>

<p>I have no doubt that the foundation of much of what I was later able to achieve
was fostered in this environment; whether it was originally making the code available
for the <a href="http://e.govt.nz" title="The original Plone site">e-government website</a>,
<a href="http://psnetwork.org.nz/blog/" title="More than you would ever want to read on this…">blogging about social media in the public sector</a>,
working with the other public service communications managers on the
<a href="http://www.psnetwork.org.nz/resources-comms-function-review/" title="A Review of the Communications Function in NZ Govt">Review of the Function</a>,
or issuing the <acronym title="Request For Proposal">RFP</acronym> for the rebuild
of the SSC website with the stipulation that the solution had to be
open source so that we could reuse it across government.</p>

<p>You can probably see a theme emerging here. If you have read this blog at all, you will
definitely see where this is heading…</p>

<p>Anyway, I am about to start focussing on technology—and open source technology in
particular—on a full time basis. From the middle of this month, I join the team at
<a href="http://catalyst.net.nz/" title="Catalyst homepage">Catalyst</a>, New Zealand&#8217;s leading
open source company, where I will be the newly minted Strategy and Relations Manager.</p>

<p>I&#8217;m thrilled to be able to work for a company that is dedicated to driving the uptake
of open source by businesses and government. Both the
<a href="http://arstechnica.com/business/news/2012/03/red-hat-hits-a-billion-dollars-in-revenue-a-milestone-for-open-source.ars" title="Red Hat hits $1billion">private</a>
and <a href="http://www.zdnet.co.uk/news/business-of-it/2012/03/22/iceland-swaps-windows-for-linux-in-open-source-push-40154870/" title="Iceland dumps windows for Linux in the public sector">public sectors</a>
around the world are really starting to grasp the strategic and economic benefits of using
open source; we are going to be doing our best to accelerate that adoption.</p>

<h5>Notes</h5>

<ol>
<li>I have used the term proudly for the last eight years, and will continue to do so…</li>
<li>Yes, my <a href="http://twitter.com/jasonwryan">twitter stream</a> will likely become a little more colourful.</li>
</ol>


<p>Creative Commons image by <a href="http://www.flickr.com/photos/swamibu/4153715570/lightbox/">Swamibu</a>
on Flickr</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Moving to Octopress]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/03/30/octopress/"/>
    <updated>2012-03-30T12:30:00+13:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/03/30/octopress</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://dl.dropbox.com/u/261312/Blog-images/octopress_logo.png" width="240" height="240" title="Octopress Logo" ></p>

<p>Over the last week I have been moving my blog over to <a href="http://octopress.org/">Octopress</a>,
a lightweight blogging framework for <a href="https://github.com/mojombo/jekyll">Jekyll</a>,
the static site generator powering <a href="http://pages.github.com/">Github Pages</a>. I had previously
been posting to a <a href="https://www.tumblr.com/">tumblr</a> page and, over the nearly four years that
I had been doing that I had somehow racked up just over 4000 posts. I was <em>not</em>
looking forward to migrating across.</p>

<p>However, the fact that the Jekyll project has a number of scripts for
<a href="https://github.com/mojombo/jekyll/wiki/blog-migrations">migrating from other platforms</a>
assuaged my concerns about the difficulty of this task. That sense of relief was shortlived.
Neither of the two tumblr migration scripts were of any assistance: both would die during their
initial runs, probably due to some funky characters in the post titles, or perhaps the posts themselves.</p>

<p>I certainly had no intention of trying to wade through the entire back catalogue identifying the
rogue posts. Rather that admit defeat, and probably more due to a sense of misguided optimism about the
“straightforward” nature of the task, I saw this setback as an opportunity to cull all of the
cruft<sup>1</sup> from the blog and decided to manually import the fifty posts that I thought were of
some interest.</p>

<p>Being an assiduous record keeper, all of the posts were helpfully bookmarked on
<a href="https://pinboard.in/u:jasonwryan/t:jwr/">Pinboard under one tag</a>, and therefore it was
simple enough to create a list of the required <acronym title="Unique Resource Locator">URLs</acronym>.
Armed with this list, it was just a matter of cobbling together a script to do the bulk of
the work for me.</p>

<p>The first task was to retrieve the posts from the list:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="c"># grab files</span>
</span><span class='line'><span class="k">while </span><span class="nb">read </span>url; <span class="k">do </span>
</span><span class='line'><span class="k">    </span>wget --adjust-extension <span class="s2">&quot;${url}&quot;</span>
</span><span class='line'><span class="k">done</span> &lt; /home/jason/Scripts/list
</span></code></pre></div></figure>


<p>Then I needed to remove all of the <acronym title="HyperText Markup Language">HTML</acronym>
surrounding the actual posts: an <code>awk</code> one-liner took care of that.</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="c"># strip HTML cruft</span>
</span><span class='line'><span class="k">for </span>file in *.html; <span class="k">do</span>
</span><span class='line'><span class="k">  </span>awk <span class="s1">&#39;/&lt;h3&gt;/ {flag=1;next} /&lt;\/div&gt;/{flag=0} flag {print}&#39;</span> <span class="s2">&quot;$file&quot;</span> &gt; <span class="s2">&quot;${file%%.*}&quot;</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>mkdir html <span class="o">&amp;&amp;</span> mv *.html html/
</span></code></pre></div></figure>


<p>The final task of this part of the migration was to convert the HTML into
<a href="http://daringfireball.net/projects/markdown/">markdown</a>,
the format that Octopress uses. <a href="http://johnmacfarlane.net/pandoc/">Pandoc</a>
the &#8220;universal document converter&#8221; handled that job:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="c"># convert to markdown format</span>
</span><span class='line'><span class="k">for </span>file in *; <span class="k">do </span>
</span><span class='line'><span class="k">    </span>pandoc -f html -t markdown <span class="s2">&quot;$file&quot;</span> &gt; <span class="s2">&quot;$file&quot;</span>.md
</span><span class='line'><span class="k">done</span>
</span></code></pre></div></figure>


<p>The final result was fifty markdown files holding all of my posts, almost ready to
be committed to github. I say “almost” because the files still required what turned out to
be a reasonable amount of cleaning up. Pandoc did a great job, for example, but would
inexpicably break <a href="http://www.notareallink.com">multi word
hyperlinks</a> over two lines. Similarly all of the internal
links to my other posts pointed to the (meaningless) tumblr URLs<sup>2</sup>.</p>

<p>Setting up Octopress was extremely simple and quick by comparison: the
<a href="http://octopress.org/docs/">documentation is very helpful</a>. There was one slight
hitch, a <a href="https://github.com/tmm1/pygments.rb/issues/10">known issue on Arch x86_64</a>,
which was simple enough to deal with.</p>

<p>While the migration was not entirely pain-free, I am pleased that I have done it. Tumblr&#8217;s service
increasingly <a href="https://twitter.com/#!/jasonwryan/statuses/176543962276954112">left a lot to be desired</a>
but as it was a free service, I couldn&#8217;t complain too much. Or, more accurately, when I did complain,
no-one actually listened…</p>

<p>Indeed, moving to a paid service like Github
(yes, it&#8217;s free at first, but once you have enough data there you need to pay a small amount
every month) <a href="http://blog.pinboard.in/2011/12/don_t_be_a_free_user/">makes a lot of sense</a>.
The paid services I do use, like <a href="http://pinboard.in/">Pinboard</a> and
<a href="http://www.tarsnap.com/">Tarsnap</a> are both inexpensive and much more
reliable than their free counterparts<sup>3</sup>; and you get to invest in great
software that is a pleasure to use.</p>

<h5>Notes</h5>

<ol>
<li>Initially, I had set up the site as a simple holding page and dumped a whole lot
of feeds into it: twitter, bookmarks, scrobbled music, etc. Those 4000 posts were
mostly just that sort of internet detritus…</li>
<li>For creating redirections (Github pages do <em>not</em> support <span class="file">.htaccess</span>)
I can&#8217;t recommend enough the
<a href="https://github.com/rawsyntax/jekyll_alias_generator/blob/master/_plugins/alias_generator.rb">Jekyll Alias Generator</a>.
Just. Brilliant.</li>
<li>And <strong>much</strong> more scrupulous about how they use your personal data.</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Signing Your Own Key]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/03/23/key/"/>
    <updated>2012-03-23T11:36:00+13:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/03/23/key</id>
    <content type="html"><![CDATA[<p><img src="http://dl.dropbox.com/u/261312/Blog-images/key.jpg" alt="image" /></p>

<p>Some time in the last couple of days, the last of the packages in the
Community repository were signed and, thanks to the tremendous work of
the Arch developers and Trusted Users, you can fully implement package
signing in your <span class="file">/etc/pacman.conf</span>.</p>

<p>You can check the state of the signed packages with this <code>expac</code>
one-liner; it will return a list of any <em>unsigned</em> packages:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>expac -S <span class="s1">&#39;%r %n %g&#39;</span> | awk <span class="s1">&#39;$3==&quot;(null)&quot; {print $1 &quot;/&quot; $2}&#39;</span>
</span></code></pre></div></figure>


<p>Now that the packages are all signed, I updated my <span class="file">/etc/pacman.conf</span> to
take advantage of this. My overall <code>SigLevel</code> setting requires signed
packages, and—as of yesterday—I was able to move the last repository
entry over to do the same:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nv">SigLevel</span> <span class="o">=</span> Required DatabaseOptional TrustedOnly
</span><span class='line'>
</span><span class='line'><span class="o">[</span>core<span class="o">]</span>
</span><span class='line'><span class="nv">SigLevel</span> <span class="o">=</span> PackageRequired
</span><span class='line'><span class="nv">Include</span> <span class="o">=</span> /etc/pacman.d/mirrorlist
</span><span class='line'>
</span><span class='line'><span class="o">[</span>extra<span class="o">]</span>
</span><span class='line'><span class="nv">SigLevel</span> <span class="o">=</span> PackageRequired
</span><span class='line'><span class="nv">Include</span> <span class="o">=</span> /etc/pacman.d/mirrorlist
</span><span class='line'>
</span><span class='line'><span class="o">[</span>community<span class="o">]</span>
</span><span class='line'><span class="nv">SigLevel</span> <span class="o">=</span> PackageRequired
</span><span class='line'><span class="nv">Include</span> <span class="o">=</span> /etc/pacman.d/mirrorlist
</span><span class='line'>
</span><span class='line'><span class="o">[</span>multilib<span class="o">]</span>
</span><span class='line'><span class="nv">SigLevel</span> <span class="o">=</span> PackageRequired
</span><span class='line'><span class="nv">Include</span> <span class="o">=</span> /etc/pacman.d/mirrorlist
</span></code></pre></div></figure>


<p>The next step was to add my key to pacman’s keychain so that I could
sign the packages that I build using ABS or from the
<a href="https://aur.archlinux.org/" title="Arch User Repository">AUR</a>. Allan has an
<a href="http://allanmcrae.com/2011/08/pacman-package-signing-1-makepkg-and-repo-add/" title="The first in a series of four posts on signing: read them all">excellent post on setting this up</a>.</p>

<p>First, import your key into pacman’s keyring:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>pacman-key -r 0xB1BD4E40
</span></code></pre></div></figure>


<p>Then follow the prompts as you edit the key to sign, set a trust level
and save your key:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>pacman-key --edit-key 0xB1BD4E40
</span><span class='line'>gpg&gt; lsign
</span><span class='line'>...
</span><span class='line'>gpg&gt; trust
</span><span class='line'>...
</span><span class='line'>gpg&gt; save
</span></code></pre></div></figure>


<p>Then it is just a matter of changing the <code>BUILDENV</code> option in your
<span class="file">/etc/makepkg.conf</span>, which is set to <code>!sign</code>
by default. Remove the bang and include the details of the key you wish to use:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="c">#-- Packager: name/email of the person or organization building packages</span>
</span><span class='line'><span class="nv">PACKAGER</span><span class="o">=</span><span class="s2">&quot;Jason Ryan &lt;jasonwryan@gmail.com&gt;&quot;</span>
</span><span class='line'><span class="c">#-- Specify a key to use for package signing</span>
</span><span class='line'><span class="nv">GPGKEY</span><span class="o">=</span><span class="s2">&quot;B1BD4E40&quot;</span>
</span></code></pre></div></figure>


<p>Now, when you build a package, you will be prompted for your key’s
passphrase:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="o">==</span>&gt; Signing package...
</span><span class='line'>
</span><span class='line'>You need a passphrase to unlock the secret key <span class="k">for</span>
</span><span class='line'>user: <span class="s2">&quot;Jason W Ryan &lt;jasonwryan@gmail.com&gt;&quot;</span>
</span><span class='line'>2048-bit RSA key, ID B1BD4E40, created 2010-08-21
</span><span class='line'>
</span><span class='line'>Enter passphrase:
</span></code></pre></div></figure>


<p>Enter the correct passphrase and your package is built and signed:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>-&gt; Created signature file /home/jason/Build/<span class="o">{</span>pkg<span class="o">}</span>.pkg.tar.xz.sig.
</span></code></pre></div></figure>


<p>Creative Commons image by
<a href="http://www.flickr.com/photos/donovan_beeson/3185668524/" title="Coraline key on Flickr">donovanbeeson</a>
on Flickr.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[A Taxonomy of Help Vampires]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/03/17/vampires/"/>
    <updated>2012-03-17T16:25:00+13:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/03/17/vampires</id>
    <content type="html"><![CDATA[<p><img src="http://dl.dropbox.com/u/261312/Blog-images/vampire1.jpg" alt="image" /></p>

<p>If you have spent any time at all amongst online (or, for that matter,
off-line) communities, you will be familiar with the help vampire. If,
by some combination of fortune and ignorance, you haven’t come across
this term before, read Amy Hoy’s original—and definitive—
<a href="http://slash7.com/2006/12/22/vampires/" title="Amy's blog on help vampires">post on this scourge</a>,
<em>now</em>.</p>

<p>Amy has some excellent tips on identifying help vampires, however, since
she originally shed some sunlight on this odious species, they have
become even more cunning and have adapted; to the point where there are
now several varieties that you should be wary of if you are determined
to prevent your online community from becoming overrun with them.</p>

<p><strong>The Infant</strong> The easiest to spot because, due to their nascent form,
they have not developed sophisticated anti-detection strategies as yet.
Also, encouragingly, these are the most likely to respond to the
corrective measures Amy outlines in her post.</p>

<p>The infant has probably learned their dependant ways in some other
online community with a higher tolerance for their spoonfeeding needs.
Corrective measures, vigorously and repeatedly applied <em>can</em> turn them
around; but even small amounts of reinforcement of this behaviour can
quickly see them morph into one of the more sinister types…</p>

<p><img src="http://media.tumblr.com/tumblr_m10ce18Jda1qz8s9s.jpg" alt="image" /></p>

<p><strong>The Leech</strong> This reprehensible lifeform just sucks and sucks and
<em>sucks</em> until there is nothing left. Some of their forum threads may
even appear reasonable, but looking at their profile in totality tells a
shocking story. All of their posts are in their own threads, they are
not interested in helping anyone else with a problem. They will move
remorselessly from issue to issue, expecting the community to provide
answers for them at a hemorrhagic rate.</p>

<p>They won’t have made any edits to
<a href="https://wiki.archlinux.org" title="The BEST godamn GNU/Linux wiki on the web">the Wiki</a>,
no matter how trivial. They won’t
<a href="https://aur.archlinux.org" title="Arch User repository">maintain any packages</a> or donate
any time or
<a href="http://www.archlinux.org/donate/" title="Donate now and recieve a FREE package update!">money</a>
to your community. But they will be there night after night, posting
their problems and waiting for the hapless to expend their time and
energy on them. Like all parasites, they will adapt over time so remain
vigilant.</p>

<p><img src="http://dl.dropbox.com/u/261312/Blog-images/vampire3.jpg" alt="image" /></p>

<p><strong>The Fanger</strong> The out-and-out help vampire, unabashed and unashamed of
their <em>needs</em>. Their sense of entitlement will be telegraphed by needy
and demanding thread titles, often featuring exhortations like “HELP”
and “URGENT” and almost always embellished with a liberal—and, at times
of “real crises,” exclusive—use of all caps and exclamation marks.</p>

<p>The Fanger will also occasionally table (sadly, almost inevitably empty)
threats about leaving your community and going off to use some other
software; as if the dependency relationship is somehow reversed and it
is you, the community, that will suffer if they leave.</p>

<p>The other classic trait of the hardcore vampire is that, like their
fictional avatars, they see nothing when a mirror is held up to them.
You can call their behaviour as much as you like, it will have no
effect. Your only solution here is technology:
<a href="http://www.codinghorror.com/blog/2011/06/suspension-ban-or-hellban.html" title="Coding Horror on the Hell Ban">the hell ban</a>.</p>

<hr />

<p>The Arch Linux community has grown considerably since it emerged
<a href="http://www.archlinux.org/news/arch-linux-turns-10/" title="w00t!">ten years ago this month</a>. Over
the last couple of years, the forums in particular have seen a lot of
new users signing up to participate. This is unquestionably a good
thing™</p>

<p>However, Arch is clearly labelled as being for
<a href="https://wiki.archlinux.org/index.php/The_Arch_Way#User-centric" title="The Arch Way: user-centric">competent users</a>
(and here competent can equally mean accomplished – or prepared to
invest in themselves and the community to become competent) and that
means not enabling these sorts of vampiric behaviours, in whatever form
they manifest.</p>

<h5>Notes</h5>

<p>Photography is all Creative Commons licensed on Flickr by, in order of
appearance:</p>

<ul>
<li><a href="http://www.flickr.com/photos/randaldroher/2161723492/" title="The Count, by Randall Drohrer on Flickr">Randall Drohrer</a></li>
<li><a href="http://www.flickr.com/photos/phatcontroller/2620032517" title="Leech, by phatcontroler on Flickr">phatcontroller</a></li>
<li><a href="http://www.flickr.com/photos/sandrafalkevik/4465039571" title="Vampire, by Sandra Falkevik on Flickr">Sandra Falkevik</a></li>
</ul>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Simple aurphan notifier]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/03/09/aurphan/"/>
    <updated>2012-03-09T16:52:00+13:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/03/09/aurphan</id>
    <content type="html"><![CDATA[<p><img src="http://dl.dropbox.com/u/261312/Blog-images/aurphan.png" alt="image" /></p>

<p>If you are an Arch Linux user and you are not using
<a href="http://www.archlinux.org/packages/community/any/aurphan/" title="aurphan package details">aurphan</a>,
you can take a moment to hang your head in shame before you click on to
whatever the next thing is. The package description sums up perfectly
what aurphan does:</p>

<blockquote><p>Finds packages in need of maintainers, bug fixes and patches. Adopt
today!</p></blockquote>

<p>Running <code>aurphan -a</code>, for example, will identify any
<a href="https://aur.archlinux.org/" title="Arch User Repository">AUR packages</a> in your
database that are not currently maintained; allowing you to log in to
the AUR and hit the ‘Adopt’ button, leaving you feeling all worthy and
fulfilled.<sup>1</sup></p>

<p>If, like most Archers, you have a compulsive desire to automate
<em>everything</em> then clearly typing (or even remembering to type) <code>aurphan
-a</code> into a terminal periodically is as ludicrous as it is onerous. The
obvious answer is some shell script and a cron job.</p>

<p>First, the <code>cron</code> job:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>crontab -e
</span><span class='line'>@hourly aurphan -a &gt;/tmp/aurphans
</span></code></pre></div></figure>


<p>Then, as part of my
<a href="https://bitbucket.org/jasonwryan/eeepc/src/241da582a0fd/Scripts/dwm-status" title="Script in mercurial repo">dwm-status script</a>,
a function to check that there are no new additions to the file and, if
there are, flash a highlight:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>aur<span class="o">(){</span>
</span><span class='line'>    <span class="nv">aurphans</span><span class="o">=</span><span class="s2">&quot;$(awk &#39;$0 !~ /^No /&#39; /tmp/aurphans | wc -l)&quot;</span>
</span><span class='line'>    <span class="k">if</span> <span class="o">[</span> <span class="nv">$aurphans</span> -gt 0 <span class="o">]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">        </span><span class="nb">echo</span> -en <span class="s2">&quot;\x03*\x01&quot;</span>
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span></code></pre></div></figure>


<p>The awk filter excludes a null return, which is “No aurphans found.”
Now, if any of the packages that I use from the AUR are disowned, I’ll
be the first to know about it.</p>

<h5>Notes</h5>

<ol>
<li>Actual feeling may differ depending on the package you have adopted
and the amount of prescription painkillers that you are currently
ingesting…</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Chroot in LVM on LUKS on Raid: Arch Linux]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/02/13/chroot/"/>
    <updated>2012-02-13T10:25:00+13:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/02/13/chroot</id>
    <content type="html"><![CDATA[<p><img src="http://dl.dropbox.com/u/261312/Blog-images/chroot-lvm.jpg" alt="image" /></p>

<p>In <a href="http://jasonwryan.com/blog/2012/02/11/lvm/" title="Post on setting this system up">my previous post describing this setup</a>
I made the point that grub won’t be installed and that it is necessary
to <code>chroot</code> in to install grub on both drives. This is the procedure I use
to do that—and to perform any other maintenance that requires working
from a live environment.</p>

<p>Again, most of this information is on the
<a href="https://wiki.archlinux.org/index.php/Chroot" title="Arch wiki page">Arch Wiki chroot page</a>, I
am just going to fill in the detail around this setup: LVM on LUKS on
Raid1.</p>

<p>Once you have booted into your live environment, load the modules that
are required; in this case: <code>raid1</code>, <code>dm-mod</code> and <code>dm-crypt</code>.</p>

<p>Check that udev hasn’t helpfully read the superblock of your Raid drives
and assembled phantom arrays:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>cat /proc/mdstat
</span></code></pre></div></figure>


<p>I find that there are a couple there generally assigned the names
<span class="file">/dev/md126</span> and <span class="file">/dev/md127</span>.
These need to be stopped before assembling the correct arrays:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>mdadm --stop /dev/md12<span class="o">[</span>67<span class="o">]</span>
</span><span class='line'>mdadm --assemble /dev/md0 /dev/sd<span class="o">[</span>ab<span class="o">]</span>1
</span><span class='line'>mdadm --assemble /dev/md1 /dev/sd<span class="o">[</span>ab<span class="o">]</span>2
</span></code></pre></div></figure>


<p>You should now have both your arrays up and running. The next step is to
unlock your encrypted device:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>cryptsetup luksOpen /dev/md1 cryptdisk
</span></code></pre></div></figure>


<p>After entering your passphrase, your device will be unlocked. Next, make
the logical volumes available, and then check they are correct:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>vgchange --available y vgroup
</span><span class='line'>lvscan
</span></code></pre></div></figure>


<p>At this point, you are ready to mount the devices and <code>chroot</code>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>mkdir /mnt/arch
</span><span class='line'>mount /dev/mapper/vgroup-lvroot /mnt/arch
</span></code></pre></div></figure>


<p>The next steps are straight from the wiki:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nb">cd</span> /mnt/arch
</span><span class='line'>mount -t proc proc proc/
</span><span class='line'>mount -t sysfs sys sys/
</span><span class='line'>mount -o <span class="nb">bind</span> /dev dev/
</span></code></pre></div></figure>


<p>Mount the other parts of the system that you need to use in your
recovery – in this case, I need my <span class="file">/boot</span> partition:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>mount /dev/md0 boot/
</span></code></pre></div></figure>


<p>Now <code>chroot</code> to the device and define your shell:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>chroot . /bin/bash
</span></code></pre></div></figure>


<p>The wiki has some good advice about customizing your prompt to reinforce
the fact that you are in a chroot:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nb">export </span><span class="nv">PS1</span><span class="o">=</span><span class="s2">&quot;(chroot) $PS1&quot;</span>
</span></code></pre></div></figure>


<p>With everything mounted, it is just a matter of performing your
maintenance. To reinstall <code>grub</code>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="c"># grub</span>
</span><span class='line'>grub&gt; find /grub/stage1
</span><span class='line'>grub&gt; device <span class="o">(</span>hd0<span class="o">)</span> /dev/sda
</span><span class='line'>grub&gt; root <span class="o">(</span>hd0,0<span class="o">)</span>
</span><span class='line'>grub&gt; setup <span class="o">(</span>hd0<span class="o">)</span>
</span><span class='line'>grub&gt; quit
</span></code></pre></div></figure>


<p>Repeat for <span class="file">/dev/sdb</span> and both your drives will be bootable in the event
that one fails.</p>

<p>With the maintenance accomplished, all that remains is to exit the
<code>chroot</code> and unmount the devices cleanly:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nb">exit</span>
</span><span class='line'>umount <span class="o">{</span>proc,sys,dev,boot...<span class="o">}</span>
</span><span class='line'><span class="nb">cd</span> ..
</span><span class='line'>umount arch/
</span><span class='line'>reboot
</span></code></pre></div></figure>


<p>Simple.</p>

<p>Creative Commons image by
<a href="http://www.flickr.com/photos/mpd01605/4152508668/" title="Rescue Engine 6 on Flickr">MPD01605</a></p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[LVM on LUKS on RAID1 on Arch Linux]]></title>
    <link href="http://jasonwryan.github.com/blog/2012/02/11/lvm/"/>
    <updated>2012-02-11T15:58:00+13:00</updated>
    <id>http://jasonwryan.github.com/blog/2012/02/11/lvm</id>
    <content type="html"><![CDATA[<p><img src="http://dl.dropbox.com/u/261312/Blog-images/lvm-luks-raid.png" alt="image" /></p>

<p>After much procrastination, I finally got around to moving the last of
my machines to Arch Linux:
<a href="http://jasonwryan.com/blog/2010/10/04/the-setup/" title="The Setup post">my home desktop</a>,
which has been running Ubuntu since the end of 2007. I’d like to share a
few thoughts about why I finally walked away from Ubuntu, but I’ll save
that for another long post.</p>

<p>Anyway, the setup I decided on was reasonably straightforward: two 1TB
drives comprising two Raid1 devices, one for a small (150Mb)
<span class="file">/boot</span> and the other holding three logical volumes
in a LUKS crypt. This way, I have the flexibility to grow the volumes as
needed, and only require thesingle passphrase at boot to unlock the
enclosed partitions: <span class="file">/root</span>, <span class="file">swap</span>
and <span class="file">/home</span>.</p>

<p>Almost all of the information here has been gleaned gratefully from
other sources; principally the Arch Wiki entries on
<a href="https://wiki.archlinux.org/index.php/LUKS" title="Arch wiki entry">LUKS</a> and
<a href="https://wiki.archlinux.org/index.php/Lvm" title="Arch LVM article">LVM</a> and
this <a href="http://www.pindarsign.de/webblog/?p=767" title="Blog post on LUKS and LVM">helpful blog post</a>.
This post (and the next) are notes to remind me how I got here and, in
the follow-up, what I need to do to restore this build…</p>

<p>First up, prepare the two hard drives. This took roughly ~90 hours for
the 1TB drives, so allow some time:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>dd <span class="k">if</span><span class="o">=</span>/dev/random <span class="nv">of</span><span class="o">=</span>/dev/sd<span class="o">[</span>a,b<span class="o">]</span>
</span></code></pre></div></figure>


<p>Once the drives are scrubbed (read the Arch Wiki on why that is
necessary), you can move to the actual installation business. I used a
256Mb thumb drive with the most recent x86_64 netinstall image burned
to it. Boot into the live environment and set up the initial partitions
using <code>cfdisk</code>:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>cfdisk /dev/sda
</span></code></pre></div></figure>


<p>I created a 150Mb partition for <span class="file">/boot</span> - marked
with the boot flag, and then partitoned the rest of the drive. Both partitons
should be primary and be <code>FSType linux_raid</code> (the FD option). Write the
partition tabel toa file and then import it to the second drive so both are exactly the
same:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>sfdisk -d /dev/sda &gt; part-table
</span><span class='line'>sfdisk /dev/sdb &lt; part-table
</span></code></pre></div></figure>


<p>Now, set up the Raid arrays. Start by loading the required modules and
then create the two arrays. The metadata flag is important: if you are
using legacy grub, as I did, you must use the 0.90 type or your MBR will
get overwritten:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>modprobe raid1 <span class="o">&amp;&amp;</span> modprobe dm-mod
</span><span class='line'>mdadm --create /dev/md0 --level<span class="o">=</span>1 --raid-devices<span class="o">=</span>2 <span class="se">\</span>
</span><span class='line'>    --metadata<span class="o">=</span>0.90 /dev/sd<span class="o">[</span>ab<span class="o">]</span>1
</span><span class='line'>mdadm --create /dev/md1 --level<span class="o">=</span>1 --raid-devices<span class="o">=</span>2 /dev/sd<span class="o">[</span>ab<span class="o">]</span>2
</span></code></pre></div></figure>


<p><sup>NOTE: I have split some of the lines of code in this post to ensure they remain readable…</sup></p>

<p>At this point, you can switch to another TTY to watch the disks
sync—again, this could take some time, depending on the size of the
drives.</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>watch -n1 cat /proc/mdstat
</span></code></pre></div></figure>


<p>Check that it all went to plan…</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>mdadm --misc --detail /dev/md<span class="o">[</span>01<span class="o">]</span> | less
</span></code></pre></div></figure>


<p>Once the drives are synched and pronounced clean, it it time to encrypt
the second Raid device, <span class="file">dev/md1</span>. You can’t encrypt
the array that contains <span class="file">/boot</span>,
but having it duplicated in a Raid array means that, ifone drive goes down,
you can still boot the other.</p>

<p>Load the module for encryption, and then set it up:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>modprobe dm-crypt
</span><span class='line'>cryptsetup --cipher<span class="o">=</span>aes-xts-plain --verify-passphrase <span class="se">\</span>
</span><span class='line'>    --key-size<span class="o">=</span>512 luksFormat /dev/md1
</span></code></pre></div></figure>


<p>Now, open the encrypted device to create the logical volumes:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>cryptsetup luksOpen /dev/md1 cryptdisk   <span class="o">[</span>1<span class="o">]</span>
</span></code></pre></div></figure>


<p>The three next steps create, in this order, the physical volume (the
container, if you will), the group and then the individual volumes
contained in the group. Choose simple, memorable names and do not
hypenate them. The {pv,vg,lv}display commands print out the details of
the devices once created.</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>pvcreate /dev/mapper/cryptdisk
</span><span class='line'>pvdisplay
</span><span class='line'>
</span><span class='line'>vgcreate vgroup /dev/mapper/cryptdisk
</span><span class='line'>vgdisplay
</span><span class='line'>
</span><span class='line'>lvcreate --size 20G --name lvroot vgroup
</span><span class='line'>lvcreate --contiguous y --size 2G --name lvswap vgroup
</span><span class='line'>lvcreate --extents +100%FREE --name lvdata vgroup
</span><span class='line'>lvdisplay
</span></code></pre></div></figure>


<p>It should be pointed out that the
<a href="https://github.com/Dieterbe/aif" title="AIF on Github">Arch Installer Framework</a> supports
LUKS and LVM, so you can accomplish these last two steps from within the
installer. I tried both and I found that I had a little more control
doing it manually, but YMMV.</p>

<p>At this point, you are ready to enter the installer and complete the
install. Run /arch/setup and move through the early setup until you
reach the &#8216;Prepare Hard Drives&#8217; section. Select option 3, &#8216;Configure block
devices, mountpoints and filesystems&#8217;. Make sure that the only “raw”
device that you configure is <span class="file">/dev/md0</span>, your
<span class="file">/boot</span> partition. Otherwise,
you are configuring the logical volumes, <em>not</em> the devices they are
built on.</p>

<p>After succesfully setting up the drives, install the base packages and
then, once that is complete, switch TTYs and update your Raid
configuration <em>prior to configuring your system</em>. This means that when
your <code>initrd</code> is regenerated, it will inlcude the correct Raid
information:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>mdadm --examine --scan &gt; /mnt/etc/mdadm.conf
</span></code></pre></div></figure>


<p>When you are done, move to configure your system and make sure to add
the relevant details to both your <span class="file">/etc/rc.conf</span> and your
<span class="file">/etc/mkinitcpio.conf</span>. In the former:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nv">USELVM</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
</span><span class='line'><span class="nv">USEDMRAID</span><span class="o">=</span><span class="s2">&quot;yes&quot;</span>
</span></code></pre></div></figure>


<p>and in /etc/mkinitcpio.conf:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nv">MODULES</span><span class="o">=</span><span class="s2">&quot;... dm_mod dm_crypt aes_x86_64 raid1 ...&quot;</span>
</span><span class='line'><span class="nv">HOOKS</span><span class="o">=</span><span class="s2">&quot;... udev mdadm_udev encrypt lvm2 filesystems ...&quot;</span>  <span class="o">[</span>2<span class="o">]</span>
</span></code></pre></div></figure>


<p>That is the straightforward part of the install over. The final step is
a little more tricky: installing a bootloader. My experience, and I
tried a number of times using different approaches, is that this <em>won’t
work</em>. The installer doesn’t seem to like the Raid setup, so it
complains about it:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="s2">&quot;Missing/Invalid root device for /dev/md0&quot;</span>
</span></code></pre></div></figure>


<p>It’s not all bad, as this is the final hurdle and it is not a
particularly high one.</p>

<p>The important step is to ensure that your <span class="file">/boot/grub/menu.lst</span> is setup
correctly. Given the names I chose above for my devices, mine looks like
this:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="c"># (0) Arch</span>
</span><span class='line'>title  Arch Linux
</span><span class='line'>root   <span class="o">(</span>hd0,0<span class="o">)</span>
</span><span class='line'>kernel /vmlinuz26 <span class="nv">root</span><span class="o">=</span>/dev/mapper/vgroup-lvroot <span class="se">\</span>
</span><span class='line'><span class="nv">cryptdevice</span><span class="o">=</span>/dev/md1:vgroup ro
</span><span class='line'>initrd /kernel26.img
</span><span class='line'>
</span><span class='line'><span class="c"># (1) Arch Fallback</span>
</span><span class='line'>title  Arch Linux Fallback
</span><span class='line'>root   <span class="o">(</span>hd0,0<span class="o">)</span>
</span><span class='line'>kernel /vmlinuz26 <span class="nv">root</span><span class="o">=</span>/dev/mapper/vgroup-lvroot <span class="se">\</span>
</span><span class='line'><span class="nv">cryptdevice</span><span class="o">=</span>/dev/md1:vgroup ro
</span><span class='line'>initrd /kernel26-fallback.img
</span></code></pre></div></figure>


<p>Once it is all setup, simply exit the installer. At this point, you have
a perfectly secure, redundant, new Arch Linux install that you can’t
boot into. You have two choices; chroot in and manually install grub
now, or reboot and do it then. I opted for the latter as it would be
more like a recovery mission—and I wanted to make sure that I was
capable enough to manage that before committing all of my backed-up data
to the machine.</p>

<p>I’ll post the details of the relatively straightforward steps required
to chroot into the system and install grub on both hard drives in a
couple of days.</p>

<h5>Notes</h5>

<ol>
<li><p>The name <code>cryptdisk</code> is arbitrary - just make it memorable and use it
consistently…</p></li>
<li><p>I am not sure how necessary it is to have the Raid modules included
here, given they are explicitly called in <span class="file">/etc/rc.conf</span>, but caution is
warranted. <strong>UPDATED 12/4/12</strong> as per the <a href="https://wiki.archlinux.org/index.php/Mkinitcpio#HOOKS">mkinitcpio article on the Wiki</a>
the <code>mdadm_udev</code> hook is preferred over the plain <code>mdadm</code> hook in your
<span class="file">/etc/mkinitcpio.conf</span>.</p></li>
</ol>

]]></content>
  </entry>
  
</feed>
