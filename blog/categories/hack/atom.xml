<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[Category: hack | jasonwryan.com]]></title>
  <link href="http://jasonwryan.github.com/blog/categories/hack/atom.xml" rel="self"/>
  <link href="http://jasonwryan.github.com/"/>
  <updated>2014-01-20T12:56:27+13:00</updated>
  <id>http://jasonwryan.github.com/</id>
  <author>
    <name><![CDATA[Jason Ryan]]></name>
    
  </author>
  <generator uri="http://octopress.org/">Octopress</generator>

  
  <entry>
    <title type="html"><![CDATA[Scripting with udev]]></title>
    <link href="http://jasonwryan.github.com/blog/2014/01/20/udev/"/>
    <updated>2014-01-20T10:02:00+13:00</updated>
    <id>http://jasonwryan.github.com/blog/2014/01/20/udev</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://miromiro.com/Blog-images/usb.jpg" title="Creative Commons image" >
One of the most satisfying aspects of running free and open source software is
the ability to be able to continually tinker with your setup, limited only by
your imagination and ability.  The more you do tinker, the smaller the gap
between the former and the latter, as each small project inevitably leads you
into a deeper understanding of various aspects of your system<sup>1</sup> and
how you can customize that system to suit your exact requirements.</p>

<p>Over the last couple of days, I have been playing with
<a href="http://en.wikipedia.org/wiki/Udev" title="Wikipedia page">udev</a>, the kernel device
manager, as I was attempting to run a script once a specific
<acronym title="Universal Serial Bus">USB</acronym> drive was plugged in. It
turns out, as is so often the case, that udev is only <em>part</em> of the
picture…</p>

<p>As both my work and personal laptops have relatively small
<acronym title="Solid State Drives">SSDs</acronym>, I carry around
<a href="http://alpha.libre.fm/user/jasonwryan/" title="Libre.fm profile">my music</a>
on a 1TB external drive. As the drive only contains <span class="file">.flac</span>
files, I wanted to automate the process of <code>rsync</code>’ing music from my desktop to
the drive and, for the laptops, repopulating the symlinks to
<span class="file">~/Music/</span> when the drive was plugged in.</p>

<p>My first thought was a rule in <span class="file">/etc/udev/rules.d/</span>,
using <code>RUN+=</code>. There are any number of blog posts espousing this approach and,
as I quickly discovered, they are <em>all</em> wrong. The problem with using this key is
that, as the <code>man</code> page makes clear, it is not designed for long running
programs:</p>

<p><blockquote><p>This can only be used for very short-running foreground tasks. Running an event process for a long period of time may block all further events for this or a dependent device.</p></p><p><p>Starting daemons or other long running processes is not appropriate for udev; the forked processes, detached or not, will be unconditionally killed after the event handling has finished.</p><footer><strong>udev manual</strong> <cite><a href='http://www.freedesktop.org/software/systemd/man/udev.html'>www.freedesktop.org/software/&hellip;</a></cite></footer></blockquote></p>

<p>The problem, as it manifest for me, was the drive would be blocked from
mounting until <em>after</em> the script had run, meaning <code>rsync</code> or my symlinks would
have no target.  There are various “workarounds” on the web for this, including
using <em>two</em> scripts, one to trigger the other<sup>2</sup>. Even for me, this
seemed like a
<a href="http://en.wikipedia.org/wiki/Pyrrhic_victory" title="Wikipedia entry">Pyrrhic victory</a>.</p>

<p>The correct way to do this, as I found once I uncovered
<a href="https://bbs.archlinux.org/viewtopic.php?id=149419" title="Arch BBS">this thread</a>
on the Arch boards where WonderWoofy and 65kid helpfully pieced it together, is
to use <code>SYSTEMD_WANTS</code>.  As it is described in the manual:</p>

<p><blockquote><p>THE UDEV DATABASE<br/>  The settings of device units may either be configured via unit files, or directly from the udev database (which is recommended). The following udev properties are understood by systemd:</p></p><p><p>  SYSTEMD_WANTS=<br/>  Adds dependencies of type Wants from this unit to all listed units. This may be used to activate arbitrary units, when a specific device becomes available. Note that this and the other tags are not taken into account unless the device is tagged with the "systemd" string in the udev database, because otherwise the device is not exposed as systemd unit.</p><footer><strong>man systemd.device</strong> <cite><a href='http://www.freedesktop.org/software/systemd/man/systemd.device.html'>www.freedesktop.org/software/&hellip;</a></cite></footer></blockquote></p>

<p>So, I edited <span class="file">/etc/udev/rules.d/90-usb-music.rules</span> to
remove the <code>RUN+=</code> key, using a systemd service file instead, like so<sup>3</sup>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'><span class="nv">SUBSYSTEMS</span><span class="o">==</span><span class="s2">&quot;usb&quot;</span>, ATTRS<span class="o">{</span>idProduct<span class="o">}==</span><span class="s2">&quot;1905&quot;</span>, <span class="nv">ACTION</span><span class="o">==</span><span class="s2">&quot;add&quot;</span>, ENV<span class="o">{</span>SYSTEMD_WANTS<span class="o">}==</span><span class="s2">&quot;upmusic.service&quot;</span>
</span></code></pre></div></figure></notextile></div></p>

<p>And then wrote the corresponding service file to have systemd hand off to the bash script:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>/usr/lib/systemd/system/upmusic.service </span></figcaption>
 <div class="highlight"><pre><code class='sh'><span class='line'><span class="o">[</span>Unit<span class="o">]</span>
</span><span class='line'><span class="nv">Description</span><span class="o">=</span>Update music links from Apollo
</span><span class='line'><span class="nv">Requires</span><span class="o">=</span>media-Apollo.mount
</span><span class='line'><span class="nv">After</span><span class="o">=</span>media-Apollo.mount&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[</span>Service<span class="o">]</span>
</span><span class='line'><span class="nv">ExecStart</span><span class="o">=</span>/home/jason/Scripts/upmusic&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;<span class="o">[</span>Install<span class="o">]</span>
</span><span class='line'><span class="nv">WantedBy</span><span class="o">=</span>media-Apollo.mount
</span></code></pre></div></figure></notextile></div></p>

<p>As I mentioned in my post on my
<a href="http://jasonwryan.com/blog/2013/10/28/dismount/" title="Unmount USB drives…">simple unmounting script</a>,
I use a naming convention for all my USB drives. In this case, my music is stored on Apollo, and
it is auto-mounted with
<a href="https://wiki.archlinux.org/index.php/Udiskie" title="Arch wiki page">udiskie</a>. In the
service file, systemd uses a hyphen instead of a forward slash, so the correct
designation is <code>media-Apollo.mount</code>.</p>

<p>Then it is just a matter of enabling the service with <code>systemctl enable upmusic</code> and,
whenever Apollo is plugged in to either my desktop of laptop, the appropriate
script will run and either update the files on Apollo or the symlinks on one of the
laptops.</p>

<h4>Notes</h4>

<ol>
<li>This shouldn't be taken as any sort of claim of expertise or deep
understanding of this, or any other, part of my system. See below.</li>
<li>Which is why you should never trust anything written by bloggers…</li>
<li>The definitive reference for udev rules remains
<a href="http://www.reactivated.net/writing_udev_rules.html" title="Daniel Drake's page">Writing udev rules</a></li>
</ol>


<p>Creative Commons image on Flickr by <a href="http://www.flickr.com/photos/jacobgarcia/2550146/" title="Licensed CC by Jacob Garcia">Jacob Garcia</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[BitTorrent Sync's API]]></title>
    <link href="http://jasonwryan.github.com/blog/2013/11/14/api/"/>
    <updated>2013-11-14T09:51:00+13:00</updated>
    <id>http://jasonwryan.github.com/blog/2013/11/14/api</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://miromiro.com/Blog-images/sync.png" title="Bittorrent logo" >
I have
<a href="http://jasonwryan.com/blog/2013/03/16/sync/" title="Post on the Alpha release">written previously</a>
about
<a href="http://www.bittorrent.com/sync" title="Sync webpage">BitTorrent Sync</a>, the encrypted
file syncing application that uses the bittorrent protocol to sync your data
over your <acronym title="Local Area Network">LAN</acronym>, or over the Internet,
using <a href="https://en.wikipedia.org/wiki/Peer_to_peer" title="Wikipedia page">P2P technology</a>.
I have been using it since early this year as a replacement for
dropbox.<sup>1</sup></p>

<p>At the beginning of this month, BitTorrent unveiled the
<a href="http://blog.bittorrent.com/2013/11/05/bittorrent-sync-beta-api-now-available-to-developers/" title="Sync blog announcement">Beta API</a>
for developers (meaning you have to tell them what you plan to do in order to
be issued a key). After some equivocation, I signed up with the rather flimsy
excuse of “writing a shell wrapper for the command line” and found, to my
chagrin, a key in my inbox the next morning.</p>

<p>This proved to be something of an unwelcome arrival. In theory, I was excited
about having access to a tool to query the Sync application. One of the nodes is
on my
<a href="http://jasonwryan.com/blog/2013/06/29/raspberry/" title="Post on setting up a torrent box">headless Raspberry Pi</a>
and the idea of being able to issue a command from my laptop to ascertain what
was going on in the Pi's synced folders was (and is) a tremendously attractive
one.</p>

<p>However, now that I was in
possession of the key, I felt morally obliged to do something with it. The
problem with this realization was that I had no idea how to work with an
<acronym title="Application Program Interface">API</acronym>, let alone writing
a script to accomplish my purported goal.</p>

<p>After spending some time looking at
<a href="http://www.bittorrent.com/sync/developers/api" title="Such as it is…">the documentation</a>,
and buoyed by the optimism of ignorance, I decided to make good on my promise.
My first attempt sort of worked, but was hampered as much by a serious
conceptual flaw as it was by poor implementation. I decided, in spite of any number
of Stack Overflow posts warning expressly not to do this, to use <code>awk</code> to parse
the <a href="http://www.json.org/" title="JSON homepage">JSON data</a><sup>2</sup>. This was what I would
euphemistically describe as a “learning opportunity.” The result is preserved
for posterity in my <a href="https://bitbucket.org/jasonwryan/shiv/commits/16c9dee17f097e83fb325e303d867e6fda488992?at=default" title="Bit of a trainwreck, but you have to start somewhere…">bitbucket repo</a>
(for the completists)…</p>

<p>At this point, I was fortunate that Earnestly in #archlinux introduced me to
keenerd's purpose built tool, <a href="http://kmkeen.com/jshon/" title="Kyle's site: visit it. Now.">Jshon</a>.
And by “introduced” I mean generously (and patiently) talked me through how it
worked and how I could use it with the Sync API to achieve what I was after.
After a while playing with it, there was the—inevitably belated—moment of
realization: this thing is genius! It allows you to intelligently
<em>interrogate</em> the data. Not blindly chopping at it with an increasingly complex
series of actions in <code>awk</code><sup>3</sup>; but quite directly traversing the structure and
extracting the desired elements.</p>

<p>Now I was <em>cooking</em>. Well, more to the point, I was flailing about in a smoke
filled kitchen convinced that the feeling of euphoria was inspiration—not imminent
asphyxiation. Once again, Earnestly's patience and bash skills were put to good effect.
The resulting script,
<a href="https://bitbucket.org/jasonwryan/shiv/src/tip/Scripts/syncstat" title="In bitbucket">syncstat</a>,
is undeniably a triumph of his good ideas over my own poor execution. In other
words, the fact that it works so well is testament to his ability, but any and
all faults are mine alone<sup>4</sup>.</p>

<p>And it does work. It only requires
<a href="https://www.archlinux.org/packages/?sort=&amp;q=jshon" title="Arch package db">Jshon</a>
(which you will already have installed because you use
<a href="http://jasonwryan.com/blog/2012/03/09/aurphan/" title="My post on this great utility">aurphan, right?</a>)
and a file with your synced folders and their respective secrets on each line<sup>5</sup>, like so:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>directory1 YourRe@llyTr1cky53cr3t
</span><span class='line'>directory2 H0p3fu11yY0uG3tTh31d3@
</span></code></pre></div></figure></notextile></div></p>

<p>The functionality in the script is limited at this stage to just querying the
application; I wasn't interested in pushing changes at this point. So you can
access the version of the currently installed Syncapp, upload and download
speeds, the size of synced folders and list all of their contents.</p>

<p>It is a beta release, so the odd bug is to be expected. Overall, though, the API is
a welcome addition to what is a great application. If you have an API key, add
it to your <span class="file">sync.conf</span>,
<a href="https://bitbucket.org/jasonwryan/shiv/src/tip/Scripts/syncstat" title="On bitbucket">grab the script</a>
and give it a whirl. Undoubtedly, over the coming weeks more polished versions
will emerge in “proper” languages, but for the time being this does exactly what
I need.</p>

<h4>Notes</h4>

<ol>
<li>Yes, I would much prefer to use an open source tool to accomplish the same
thing but I haven't found anything comparable that is this good to date…</li>
<li>In what I imagine is a complete coincidence, the JSON logo is uncannily
similar to the initial (and much better, I thought) Sync logo, as seen on
<a href="http://jasonwryan.com/blog/2013/03/16/sync/">my original post</a>.</li>
<li>This is not intended as a slight on <code>awk</code>; which I am undoubtedly
<a href="http://jasonwryan.com/blog/2013/09/15/awking/">fond of</a>, but rather the
limits of my ability with that language.</li>
<li>I am also indebted to Scott (firecat53) for testing and providing helpful
feedback on the early versions of the script.</li>
<li>It is worth noting that in the <code>$json</code> variable, I pass <code>curl</code> the -<code>n</code> option,
which means it reads my credentials from <span class="file">$HOME/.netrc</span>.</li>
</ol>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Simple Unmounting]]></title>
    <link href="http://jasonwryan.github.com/blog/2013/10/28/dismount/"/>
    <updated>2013-10-28T15:29:00+13:00</updated>
    <id>http://jasonwryan.github.com/blog/2013/10/28/dismount</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://miromiro.com/Blog-images/dismount.jpg" title="Creative Commons image" >
For those people that prefer to forego the full blown
<acronym title="Desktop Environment">DE</acronym> and—instead of all the
“convenience” that this sort of setup offers—piece together their setup from a
variety of different tools and knit it all together with some scripting,
automounting external drives is, notwithstanding the inexplicable number of
posts to the forums to the contrary, incredibly straightforward with
<a href="https://wiki.archlinux.org/index.php/Udev#Udisks" title="Arch Wiki page on Udev">udisks</a>.
My approach in this respect is to use
<a href="https://wiki.archlinux.org/index.php/Udiskie" title="Wiki page">udiskie</a>; it is
lightweight, unobtrusive, configurable and foolproof, as far as I can tell.</p>

<p>Where I have found a small gap, or more a minor irritation really, is with
unmounting devices. <code>udiskie-umount /media/MY_USB_DRIVE</code> works just fine, but
I often have a variety of media mounted, and not just standard
<acronym title="Universal Serial Bus">USB</acronym> drives. At work, for
example, it is not uncommon for me to have mounted under
<span class="file">/media</span> any or all of the following:</p>

<ul>
<li>A USB drive containing all of my music</li>
<li>An encrypted volume mounted with
<a href="http://jasonwryan.com/blog/2013/01/10/truecrypt/" title="My post on replacing TrueCrypt">tcplay</a>
shared via <a href="http://jasonwryan.com/blog/2013/03/16/sync/" title="Another postof mine…">Bittorrent Sync</a></li>
<li>A <acronym title="Common Internet File System">CIFS</acronym> share</li>
<li>An <acronym title="Network File System">NFS</acronym> share or an
<acronym title="SSH Filesystem">SSHFS</acronym> mount.</li>
</ul>


<p>In a couple of these cases, I don't want to—or can't—just <code>umount</code> them with
<code>udiskie</code>; they require a different approach. To facilitate this, I have adopted
a simple approach: I use a standard naming convention for all external media
or their mountpoints. When I first buy a USB drive, I give it a meaningful name,
beginning with an uppercase letter, as this won't clash with any of my internal
drives and it happily accommodates drives from other operating systems. So:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>sudo dosfslabel /dev/sdc1 EightBall
</span></code></pre></div></figure></notextile></div></p>

<p>sets up a new 8GB drive I found in the schwag bag at the conference I attended
last week.</p>

<p>Now that all external media are predictably named, it is just a matter of
writing a script that checks how many are mounted, presents a menu if there is
more than one, and unmounts the respective device correctly:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>dismount </span></figcaption>
 <div class="highlight"><pre><code class='sh'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;!/usr/bin/env bash&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;unmount USB drives&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;target<span class="o">=(</span> <span class="k">$(</span>awk <span class="s1">&#39;/media\/[\&lt;sup&gt;A-Z]/&lt;/sup&gt; {print $3}&#39;</span> &amp;lt;<span class="o">(</span>mount<span class="k">)</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'><span class="nv">shares</span><span class="o">=(</span>Scout Sentinel<span class="o">)</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;checkbusy<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  grep <span class="s2">&quot;PID&quot;</span> &amp;lt;<span class="o">(</span>lsof +d <span class="s2">&quot;$target&quot;</span> &amp;amp;&gt;/dev/null<span class="o">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;printf <span class="s2">&quot;%s\n&quot;</span> <span class="s2">&quot;${target##*/} busy…&quot;</span>
</span><span class='line'><span class="nb">exit </span>1
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;exstatus<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;printf <span class="s2">&quot;%s\n&quot;</span> <span class="s2">&quot;${target##*/} unmounted…&quot;</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  <span class="k">else</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;printf <span class="s2">&quot;%s\n&quot;</span> <span class="s2">&quot;Failed to unmount.&quot;</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;check <span class="k">for </span>multiple devices&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;if <span class="o">((</span> <span class="s2">&quot;${#target[@]}&quot;</span> &gt; 1 <span class="o">))</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">PS3</span><span class="o">=</span><span class="s2">&quot;Select your device to unmount: &quot;</span>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;%s\n&quot;</span> <span class="s2">&quot;There are ${#target[@]} devices mounted&quot;</span>
</span><span class='line'>  <span class="k">select </span>dev in <span class="s2">&quot;${target[@]}&quot;</span>; <span class="k">do</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;target<span class="o">=</span><span class="s2">&quot;$dev&quot;</span>
</span><span class='line'><span class="nb">break</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  <span class="k">done</span>
</span><span class='line'><span class="k">fi</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;check <span class="k">for </span>share&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;for drive in <span class="s2">&quot;${shares[@]}&quot;</span>; <span class="k">do</span>
</span><span class='line'><span class="k">  if</span> <span class="o">[[</span> <span class="s2">&quot;$drive&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;${target##*/}&quot;</span> <span class="o">]]</span>; <span class="k">then</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;share<span class="o">=</span><span class="s2">&quot;$drive&quot;</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  <span class="k">fi</span>
</span><span class='line'><span class="k">done</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;options per filesystem&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;if <span class="o">[[</span> -n <span class="s2">&quot;$target&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  for </span>drive in <span class="s2">&quot;${shares[@]}&quot;</span>; <span class="k">do</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;if <span class="o">[[</span> <span class="s2">&quot;$drive&quot;</span> <span class="o">=</span> <span class="s2">&quot;${target##*/}&quot;</span> &amp;amp;&amp;amp; <span class="s2">&quot;${target##*/}&quot;</span> <span class="o">=</span> Safebox <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">cmd</span><span class="o">=</span><span class="k">$(</span>sudo safebox close<span class="k">)</span>
</span><span class='line'><span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$drive&quot;</span> <span class="o">=</span> <span class="s2">&quot;${target##*/}&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">cmd</span><span class="o">=</span><span class="k">$(</span>sudo umount <span class="s2">&quot;$target&quot;</span><span class="k">)</span>
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">  </span><span class="nv">cmd</span><span class="o">=</span><span class="k">$(</span>udiskie-umount -d <span class="s2">&quot;$target&quot;</span> &amp;amp;&amp;gt;/dev/null<span class="k">)</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;  <span class="k">done</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;do it&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;checkbusy
</span><span class='line'><span class="nv">$cmd</span>
</span><span class='line'>exstatus
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">  </span><span class="nb">printf</span> <span class="s2">&quot;%s\n&quot;</span> <span class="s2">&quot;No drive mounted!&quot;</span>
</span><span class='line'><span class="k">fi</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;vim:set <span class="nv">ts</span><span class="o">=</span>2 <span class="nv">sts</span><span class="o">=</span>2 <span class="nv">sw</span><span class="o">=</span>2 et:&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span></code></pre></div></figure></notextile></div></p>

<p>Now, no matter the number or type of devices I currently have mounted, I can
unmount them by typing <code>dismount</code> and choosing the appropriate drive via the
<code>select</code> menu. Simple, but satisfying. The script is in my
<a href="https://bitbucket.org/jasonwryan/centurion/src/tip/Scripts/dismount%20'Grab%20it!">bitbucket repo</a></p>

<h4>Notes</h4>

<p>Creative Commons image, Dismount, by
<a href="http://www.flickr.com/photos/chrisinplymouth/3659964278/">Chris</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Managing modules with Awk]]></title>
    <link href="http://jasonwryan.github.com/blog/2013/09/15/awking/"/>
    <updated>2013-09-15T09:23:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2013/09/15/awking</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://miromiro.com/Blog-images/awk.jpg" title="The Great Auk" >
This is an addendum to my two previous posts on
<a href="http://jasonwryan.com/blog/2013/08/03/kernels/" title="The first post">compiling kernels</a>
and <a href="http://jasonwryan.com/blog/2013/08/24/automating-kernels/" title="The folow up">automating the process</a>.
In the first of those posts I wrote about a wonderful tool to track the modules
necessary for building a custom kernel with <code>make localmodconfig</code>, graysky's
<a href="https://github.com/graysky2/modprobed_db" title="Github repo">modprobed_db</a>. A simple
bash script, <code>modprobed_db</code> allows you to build up an array of modules and—as
the name suggests—<code>modprobe</code> all of them prior to compilation.</p>

<p>I forked it on github and started to play around with the script (mostly because
I am slightly <acronym title="Obsessive Compulsive Disorder">OCD</acronym> about
constructions
<a href="https://github.com/graysky2/modprobed_db/blob/master/common/modprobed_db#L62" title="awk pipeline">like this</a>:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>modprobed_db lines 62-63 </span></figcaption>
 <div class="highlight"><pre><code class='sh'><span class='line'>cat /proc/modules | awk <span class="s1">&#39;{print $1}&#39;</span> | sort -k 1,1 | <span class="se">\&lt;</span>/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;grep -Ev <span class="s2">&quot;$(echo ${IGNORE[*]} | sed -e &#39;s/^/^(/&#39; -e &#39;s/ /|/g&#39; -e &#39;s/$/)$/&#39;)&quot;</span> <span class="se">\</span>
</span><span class='line'>&amp;gt;/tmp/.inmem
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;
</span></code></pre></div></figure></notextile></div></p>

<p><a href="https://github.com/jasonwryan/modprobed_db/blob/jwr/common/modprobed_db" title="My branch">After hacking a while</a>,
I started to realize that the venerable UNIX programme
<a href="http://www.gnu.org/software/gawk/manual/" title="gawk manual on GNU site">Awk</a>
 would, in many ways, be a better tool for this job. Essentially, we want to
 manage three lists: the modules in <span class="file">/proc/modules</span>, a
 list of modules to ignore, and the master list of all modules required prior to
 compilation. This seems perfectly suited to Awk.</p>

<p> So, in the interests of learning Awk, I decided to rewrite the required
 functionality (or, more correctly, the subset that I required) in this
 language. This wasn't a straightforward task for me. I got stuck a couple of
 times and, as I work in a building full of
 <a href="http://catalyst.net.nz" title="Catalyst website">neckbeards</a>, I thought I could ask
 for a couple of pointers. To my surprise, no-one I asked seemed interested in
 Awk. Typical responses were along the lines of “just use Perl.”</p>

<p> Aside from not knowing any
 <a href="http://www.perl.org/" title="Perl homepage">Perl</a>, and being unlikely to learn any
 in the immediate future, I was bemused by the notion that none of these skilled
 developers rated Awk as a language worth knowing. One of the #awk FAQ's
 specifically addresses this:
 <a href="http://awk.freeshell.org/Frequently_Asked_Questions#toc14" title="#awk FAQs">Why would anyone still use awk instead of perl?</a>
 The quote by Tom Christiansen is worth repeating here:</p>

<p> <blockquote><p>Awk is a venerable, powerful, elegant, and simple tool that everyone should know. Perl is a superset and child of awk, but has much more power that comes at expense of sacrificing some of that simplicity.</p></blockquote></p>

<p>In a happy coincidence, this
<a href="http://unix.stackexchange.com/questions/90489/compare-two-files-with-first-column-and-remove-duplicate-row-from-2nd-file-in-sh/90490#90490" title="Comparing two files">question on Unix &amp; Linux SE</a>
showed up just as I was completing my script and it neatly illustrates (to my
unututored eye, anyway) an example of a typical situation where Awk's strengths
make it a better approach than Perl.</p>

<p>In any event, my rewriting of <code>modprobed_db</code> in Awk<sup>1</sup> resulted in this:</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>awkmodules </span></figcaption>
 <div class="highlight"><pre><code class='awk'><span class='line'><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;!</span><span class="err">/usr/bin/awk -f&lt;/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">script</span> <span class="nx">to</span> <span class="nx">manage</span> <span class="nx">modules</span> <span class="k">for</span> <span class="nx">kernel</span> <span class="nx">builds</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">BEGIN</span> <span class="p">{</span> <span class="nx">dbfile</span> <span class="o">=</span> <span class="nb">ARGV</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="kd">function</span> <span class="nx">red</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">pre</span><span class="o">&gt;&lt;</span><span class="nx">code</span><span class="o">&gt;</span><span class="kr">printf</span> <span class="s2">&quot;\033[1;31m&quot;</span> <span class="nx">s</span> <span class="s2">&quot;\033[0m &quot;</span>
</span><span class='line'><span class="o">&lt;</span><span class="err">/code&gt;&lt;/pre&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">read</span> <span class="o">in</span> <span class="nx">the</span> <span class="nx">array</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nb">FILENAME</span> <span class="o">!=</span> <span class="nb">ARGV</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">modlist</span><span class="p">[</span><span class="o">$</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span> <span class="kr">next</span>
</span><span class='line'><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">check</span> <span class="k">for</span> <span class="nx">ignored</span> <span class="nx">modules</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;!</span><span class="nx">modlist</span><span class="p">[</span><span class="o">$</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">print</span> <span class="o">$</span><span class="mi">1</span> <span class="o">&gt;&gt;</span> <span class="nx">dbfile</span>
</span><span class='line'>  <span class="kr">close</span><span class="p">(</span><span class="nx">dbfile</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">modprobe</span> <span class="nx">modules</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">modload</span><span class="o">=</span><span class="s2">&quot;sudo modprobe -a $(&amp;lt;&quot;</span><span class="nx">dbfile</span><span class="s2">&quot;)&quot;</span>
</span><span class='line'>  <span class="kr">system</span><span class="p">(</span><span class="nx">modload</span><span class="p">)</span>
</span><span class='line'>  <span class="kr">close</span><span class="p">(</span><span class="nx">modload</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="p">{</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">update</span> <span class="nx">module</span> <span class="nx">count</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="k">if</span> <span class="p">(</span> <span class="kr">getline</span> <span class="err">&amp;</span><span class="nx">lt</span><span class="p">;</span> <span class="nx">dbfile</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">count</span><span class="o">++</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span><span class="nx">END</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">print</span> <span class="nx">red</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="s2">&quot;modules listed.&quot;</span>
</span><span class='line'><span class="p">}</span><span class="o">&lt;</span><span class="err">/p&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">h1</span><span class="o">&gt;</span><span class="nx">vim</span><span class="err">:</span><span class="nx">set</span> <span class="nx">ts</span><span class="o">=</span><span class="mi">2</span> <span class="nx">sts</span><span class="o">=</span><span class="mi">2</span> <span class="nx">sw</span><span class="o">=</span><span class="mi">2</span> <span class="nx">et</span><span class="err">:</span><span class="o">&lt;</span><span class="err">/h1&gt;</span>
</span><span class='line'>
</span><span class='line'><span class="o">&lt;</span><span class="nx">p</span><span class="o">&gt;</span>
</span></code></pre></div></figure></notextile></div></p>

<p>Just prior to compiling a kernel, I can invoke this script with (the admittedly
rather ungainly line):</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>awkmodules <span class="nv">p</span><span class="o">=</span>1 .config/kmod_db/ignored .config/kmod_db/modules_db /proc/modules
</span></code></pre></div></figure></notextile></div></p>

<p>It does work, but I don't claim that it is either idiomatic or attractive. The
use of <code>getline</code> to update the module count strikes me as especially kludgy but
I haven't been able to think of a more correct way to handle it.</p>

<p>Incidentally, the gawk manual<sup>2</sup>,
<a href="http://www.gnu.org/software/gawk/manual/" title="GNU goodness">Gawk: Effective AWK Programming</a>
has only just been updated<sup>3</sup> so Awk is, unlike it's homonym, clearly
alive and well.</p>

<h4>Notes</h4>

<ol>
<li>In my <a href="https://bitbucket.org/jasonwryan/shiv/src/tip/Scripts/awkmodules">bitbucket repo</a>.</li>
<li>The number of variants of <code>awk</code> is as much a delight as it is perplexing…</li>
<li>May, 2013</li>
</ol>


<p>Public Domain image of the Great Auk by John James Audubon, from his book
<a href="https://en.wikipedia.org/wiki/File:PinguinusImpennus.jpg">The Birds of America</a>.</p>
]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Automating Kernel Builds]]></title>
    <link href="http://jasonwryan.github.com/blog/2013/08/24/automating-kernels/"/>
    <updated>2013-08-24T10:30:00+12:00</updated>
    <id>http://jasonwryan.github.com/blog/2013/08/24/automating-kernels</id>
    <content type="html"><![CDATA[<p><img class="left" src="http://miromiro.com/Blog-images/robot.jpg" title="I Robot" >
I posted a couple of weeks ago about
<a href="http://jasonwryan.com/blog/2013/08/03/kernels/" title="Check it if you haven't...">compiling a custom kernel</a>
using <a href="https://github.com/graysky2/modprobed_db" title="graysky's github repo">modprobed_db</a>
and at the time I talked about automating the process, essentially so that every
kernel update, be it the standard Arch kernel or the stripped down custom one,
would be a simple, streamlined process. I updated that post with
<a href="https://bitbucket.org/jasonwryan/shiv/src/tip/Build/linux-jwr/PKGBUILD" title="bitbucket repo">a PKGBUILD</a>,
which was the first step. This completes that process.</p>

<p>There is not a lot to it. A
<a href="https://bitbucket.org/jasonwryan/shiv/src/tip/Scripts/new_kernel" title="bitbucket repo">short bash wrapper</a>
that sets up the required files, updates the aforementioned PKGBUILD and then
triggers <code>makepkg</code> (providing nothing else fails). All it requires is that you
have
<a href="https://bitbucket.org/jasonwryan/shiv/src/tip/Build/linux-jwr%20'You%20guessed%20it%E2%80%A6">the necessary files</a>
in a separate directory for the script to reference and
you are set. If anything does go wrong with the new kernel, you still have the
previous working custom kernel <code>.tar.xz</code> you can reinstall, or you can of course
just boot into the vanilla Arch kernel.</p>

<p><div class='bogus-wrapper'><notextile><figure class='code'><figcaption><span>new_kernel </span></figcaption>
 <div class="highlight"><pre><code class='bash'><span class='line'>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;!/usr/bin/env bash&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;install new kernel&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;vers<span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">cyn</span><span class="o">=</span><span class="s1">$&#39;\e[1;36m&#39;</span>
</span><span class='line'><span class="nv">ylw</span><span class="o">=</span><span class="s1">$&#39;\e[1;33m&#39;</span>
</span><span class='line'><span class="nv">red</span><span class="o">=</span><span class="s1">$&#39;\e[1;31m&#39;</span>
</span><span class='line'><span class="nv">end</span><span class="o">=</span><span class="s1">$&#39;\e[0m&#39;</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;if <span class="o">[[</span> <span class="nv">$# </span>!<span class="o">=</span> 1 <span class="o">]]</span>; <span class="k">then</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;printf <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&quot;Usage: &quot;</span><span class="k">${</span><span class="nv">0</span><span class="p">##*/</span><span class="k">}</span><span class="s2">&quot; 3.10.8&quot;</span>
</span><span class='line'><span class="nb">exit </span>1
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;fi&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;back up last dir&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;cd ~/Build
</span><span class='line'>rm -rf linux-jwr/<span class="o">{</span>pkg,src<span class="o">}</span>
</span><span class='line'>mv linux-jwr linux-<span class="k">${</span><span class="nv">vers</span><span class="p">%.&lt;em&gt;</span><span class="k">}</span>.<span class="k">$((${</span><span class="nv">vers</span><span class="p">##&lt;/em&gt;.</span><span class="k">}</span> <span class="o">-</span> <span class="m">1</span><span class="k">))</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;h1&gt;set up clean files&lt;/h1&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;cp -r kernel_files linux-jwr &amp;amp;&amp;amp; <span class="nb">cd</span> <span class="s2">&quot;$_&quot;</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;sed -i <span class="s2">&quot;s:pkgver=[0-9].*:pkgver=${vers}:&quot;</span> PKGBUILD
</span><span class='line'><span class="nv">newvers</span><span class="o">=</span><span class="k">$(</span>awk -F<span class="o">=</span> <span class="s1">&#39;/pkgver=/ {print $2}&#39;</span> PKGBUILD<span class="k">)</span>
</span><span class='line'><span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&quot;Package version updated to ${ylw}$newvers${end}&quot;</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;printf <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&quot;${cyn}Updating checksums…${end}&quot;</span>
</span><span class='line'>/usr/bin/updpkgsums&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;if <span class="o">[[</span> <span class="nv">$?</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;printf <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&quot;${cyn}Starting build…${end}&quot;</span>
</span><span class='line'>/usr/bin/time /usr/bin/makepkg -i
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;else&lt;/p&gt;
</span><span class='line'>
</span><span class='line'>&lt;pre&gt;&lt;code&gt;printf <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&quot;${red}Checksum failed${end}&quot;</span>
</span><span class='line'><span class="nb">exit </span>1
</span><span class='line'>&lt;/code&gt;&lt;/pre&gt;
</span><span class='line'>
</span><span class='line'>&lt;p&gt;fi
</span><span class='line'><span class="nb">cd</span>
</span></code></pre></div></figure></notextile></div></p>

<p>That's all there is to it. I see in my RSS reader that a new stable kernel is
available, open a terminal and run the script specifying which version to use,
for example, <code>new_kernel 3.10.9</code>.  Approximately 10 minutes later, my new kernel
is compiled and installed and I can reboot into it. Simple.</p>

<p>Undoubtedly, there is probably a cleaner way to do this, but it has worked well
for the last couple of kernels. It will probably also require tweaking for the
next series, but until that time, I am quite happy with it.</p>

<h4>Notes</h4>

<p>Flickr creative commons image
<a href="http://www.flickr.com/photos/fringley/4244586360/">My robot</a> by fringley.</p>
]]></content>
  </entry>
  
</feed>
