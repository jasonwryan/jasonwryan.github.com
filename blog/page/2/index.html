
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>jasonwryan.com</title>
  <meta name="author" content="Jason Ryan">

  
  <meta name="description" content="For those people that prefer to forego the full blown
DE and—instead of all the
“convenience” that this sort of setup offers—piece together their &hellip;">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://jasonwryan.github.com/blog/page/2">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="jasonwryan.com" type="application/atom+xml">
  <!-- OpenId login -->
<link rel="openid.server" href="http://openid.claimid.com/server" />
<link rel="openid.delegate" href="http://openid.claimid.com/jasonwryan" />

<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">

  
  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-907012-2']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>


</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">jasonwryan.com</a></h1>
  
    <h2>Miscellaneous ephemera…</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://www.duckduckgo.com/" method="get">
  <fieldset role="search">
    <!-- <input type="hidden" name="q" value="site:jasonwryan.github.com" /> -->
    <input type="hidden" name="sites" value="jasonwryan.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search duckduckgo&hellip;"/>
  </fieldset>
</form>
  
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="/contact.html">Contact</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div class="blog-index">
  
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/10/28/dismount/">Simple Unmounting</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-10-28T15:29:00+13:00" pubdate data-updated="true">Oct 28<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="left" src="http://miromiro.com/Blog-images/dismount.jpg" title="Creative Commons image" >
For those people that prefer to forego the full blown
<acronym title="Desktop Environment">DE</acronym> and—instead of all the
“convenience” that this sort of setup offers—piece together their setup from a
variety of different tools and knit it all together with some scripting,
automounting external drives is, notwithstanding the inexplicable number of
posts to the forums to the contrary, incredibly straightforward with
<a href="https://wiki.archlinux.org/index.php/Udev#Udisks" title="Arch Wiki page on Udev">udisks</a>.
My approach in this respect is to use
<a href="https://wiki.archlinux.org/index.php/Udiskie" title="Wiki page">udiskie</a>; it is
lightweight, unobtrusive, configurable and foolproof, as far as I can tell.</p>

<p>Where I have found a small gap, or more a minor irritation really, is with
unmounting devices. <code>udiskie-umount /media/MY_USB_DRIVE</code> works just fine, but
I often have a variety of media mounted, and not just standard
<acronym title="Universal Serial Bus">USB</acronym> drives. At work, for
example, it is not uncommon for me to have mounted under
<span class="file">/media</span> any or all of the following:</p>

<ul>
<li>A USB drive containing all of my music</li>
<li>An encrypted volume mounted with
<a href="http://jasonwryan.com/blog/2013/01/10/truecrypt/" title="My post on replacing TrueCrypt">tcplay</a>
shared via <a href="http://jasonwryan.com/blog/2013/03/16/sync/" title="Another postof mine…">Bittorrent Sync</a></li>
<li>A <acronym title="Common Internet File System">CIFS</acronym> share</li>
<li>An <acronym title="Network File System">NFS</acronym> share or an
<acronym title="SSH Filesystem">SSHFS</acronym> mount.</li>
</ul>


<p>In a couple of these cases, I don&#8217;t want to—or can&#8217;t—just <code>umount</code> them with
<code>udiskie</code>; they require a different approach. To facilitate this, I have adopted
a simple approach: I use a standard naming convention for all external media
or their mountpoints. When I first buy a USB drive, I give it a meaningful name,
beginning with an uppercase letter, as this won&#8217;t clash with any of my internal
drives and it happily accommodates drives from other operating systems. So:</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>sudo dosfslabel /dev/sdc1 EightBall
</span></code></pre></div></figure>


<p>sets up a new 8GB drive I found in the schwag bag at the conference I attended
last week.</p>

<p>Now that all external media are predictably named, it is just a matter of
writing a script that checks how many are mounted, presents a menu if there is
more than one, and unmounts the respective device correctly:</p>

<figure class='code'><figcaption><span>dismount </span></figcaption>
 <div class="highlight"><pre><code class='sh'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'><span class="c"># unmount USB drives</span>
</span><span class='line'>
</span><span class='line'><span class="nv">target</span><span class="o">=(</span> <span class="k">$(</span>awk <span class="s1">&#39;/media\/[\^A-Z]/ {print $3}&#39;</span> &lt;<span class="o">(</span>mount<span class="k">)</span><span class="o">)</span> <span class="o">)</span>
</span><span class='line'><span class="nv">shares</span><span class="o">=(</span>Scout Sentinel<span class="o">)</span>
</span><span class='line'>
</span><span class='line'>checkbusy<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  grep <span class="s2">&quot;PID&quot;</span> &lt;<span class="o">(</span>lsof +d <span class="s2">&quot;$target&quot;</span> &amp;&gt;/dev/null<span class="o">)</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">printf</span> <span class="s2">&quot;%s\n&quot;</span> <span class="s2">&quot;${target##*/} busy…&quot;</span>
</span><span class='line'>    <span class="nb">exit </span>1
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'>exstatus<span class="o">()</span> <span class="o">{</span>
</span><span class='line'>  <span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nb">printf</span> <span class="s2">&quot;%s\n&quot;</span> <span class="s2">&quot;${target##*/} unmounted…&quot;</span>
</span><span class='line'>  <span class="k">else</span>
</span><span class='line'><span class="k">    </span><span class="nb">printf</span> <span class="s2">&quot;%s\n&quot;</span> <span class="s2">&quot;Failed to unmount.&quot;</span>
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'><span class="o">}</span>
</span><span class='line'>
</span><span class='line'><span class="c"># check for multiple devices</span>
</span><span class='line'><span class="k">if</span> <span class="o">((</span> <span class="s2">&quot;${#target[@]}&quot;</span> &gt; 1 <span class="o">))</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nv">PS3</span><span class="o">=</span><span class="s2">&quot;Select your device to unmount: &quot;</span>
</span><span class='line'>  <span class="nb">printf</span> <span class="s2">&quot;%s\n&quot;</span> <span class="s2">&quot;There are ${#target[@]} devices mounted&quot;</span>
</span><span class='line'>  <span class="k">select </span>dev in <span class="s2">&quot;${target[@]}&quot;</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    </span><span class="nv">target</span><span class="o">=</span><span class="s2">&quot;$dev&quot;</span>
</span><span class='line'>    <span class="nb">break</span>
</span><span class='line'><span class="nb">  </span><span class="k">done</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># check for share</span>
</span><span class='line'><span class="k">for </span>drive in <span class="s2">&quot;${shares[@]}&quot;</span>; <span class="k">do</span>
</span><span class='line'><span class="k">  if</span> <span class="o">[[</span> <span class="s2">&quot;$drive&quot;</span> <span class="o">=</span>~ <span class="s2">&quot;${target##*/}&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">    </span><span class="nv">share</span><span class="o">=</span><span class="s2">&quot;$drive&quot;</span>
</span><span class='line'>  <span class="k">fi</span>
</span><span class='line'><span class="k">done</span>
</span><span class='line'>
</span><span class='line'><span class="c"># options per filesystem</span>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> -n <span class="s2">&quot;$target&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  for </span>drive in <span class="s2">&quot;${shares[@]}&quot;</span>; <span class="k">do</span>
</span><span class='line'><span class="k">    if</span> <span class="o">[[</span> <span class="s2">&quot;$drive&quot;</span> <span class="o">=</span> <span class="s2">&quot;${target##*/}&quot;</span> <span class="o">&amp;&amp;</span> <span class="s2">&quot;${target##*/}&quot;</span> <span class="o">=</span> Safebox <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nv">cmd</span><span class="o">=</span><span class="k">$(</span>sudo safebox close<span class="k">)</span>
</span><span class='line'>    <span class="k">elif</span> <span class="o">[[</span> <span class="s2">&quot;$drive&quot;</span> <span class="o">=</span> <span class="s2">&quot;${target##*/}&quot;</span> <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">      </span><span class="nv">cmd</span><span class="o">=</span><span class="k">$(</span>sudo umount <span class="s2">&quot;$target&quot;</span><span class="k">)</span>
</span><span class='line'>    <span class="k">else</span>
</span><span class='line'><span class="k">      </span><span class="nv">cmd</span><span class="o">=</span><span class="k">$(</span>udiskie-umount -d <span class="s2">&quot;$target&quot;</span> &amp;&gt;/dev/null<span class="k">)</span>
</span><span class='line'>    <span class="k">fi</span>
</span><span class='line'><span class="k">  done</span>
</span><span class='line'><span class="c"># do it</span>
</span><span class='line'>checkbusy
</span><span class='line'><span class="nv">$cmd</span>
</span><span class='line'>exstatus
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">  </span><span class="nb">printf</span> <span class="s2">&quot;%s\n&quot;</span> <span class="s2">&quot;No drive mounted!&quot;</span>
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># vim:set ts=2 sts=2 sw=2 et:</span>
</span></code></pre></div></figure>


<p>Now, no matter the number or type of devices I currently have mounted, I can
unmount them by typing <code>dismount</code> and choosing the appropriate drive via the
<code>select</code> menu. Simple, but satisfying. The script is in my
<a href="https://bitbucket.org/jasonwryan/centurion/src/tip/Scripts/dismount%20'Grab%20it!">bitbucket repo</a></p>

<h4>Notes</h4>

<p>Creative Commons image, Dismount, by
<a href="http://www.flickr.com/photos/chrisinplymouth/3659964278/">Chris</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/09/15/awking/">Managing modules with Awk</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-09-15T09:23:00+12:00" pubdate data-updated="true">Sep 15<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="left" src="http://miromiro.com/Blog-images/awk.jpg" title="The Great Auk" >
This is an addendum to my two previous posts on
<a href="http://jasonwryan.com/blog/2013/08/03/kernels/" title="The first post">compiling kernels</a>
and <a href="http://jasonwryan.com/blog/2013/08/24/automating-kernels/" title="The folow up">automating the process</a>.
In the first of those posts I wrote about a wonderful tool to track the modules
necessary for building a custom kernel with <code>make localmodconfig</code>, graysky&#8217;s
<a href="https://github.com/graysky2/modprobed_db" title="Github repo">modprobed_db</a>. A simple
bash script, <code>modprobed_db</code> allows you to build up an array of modules and—as
the name suggests—<code>modprobe</code> all of them prior to compilation.</p>

<p>I forked it on github and started to play around with the script (mostly because
I am slightly <acronym title="Obsessive Compulsive Disorder">OCD</acronym> about
constructions
<a href="https://github.com/graysky2/modprobed_db/blob/master/common/modprobed_db#L62" title="awk pipeline">like this</a>:</p>

<figure class='code'><figcaption><span>modprobed_db lines 62-63 </span></figcaption>
 <div class="highlight"><pre><code class='sh'><span class='line'>cat /proc/modules | awk <span class="s1">&#39;{print $1}&#39;</span> | sort -k 1,1 | <span class="se">\</span>
</span><span class='line'>  grep -Ev <span class="s2">&quot;$(echo ${IGNORE[*]} | sed -e &#39;s/^/^(/&#39; -e &#39;s/ /|/g&#39; -e &#39;s/$/)$/&#39;)&quot;</span> <span class="se">\</span>
</span><span class='line'>  &gt;/tmp/.inmem
</span></code></pre></div></figure>


<p><a href="https://github.com/jasonwryan/modprobed_db/blob/jwr/common/modprobed_db" title="My branch">After hacking a while</a>,
I started to realize that the venerable UNIX programme
<a href="http://www.gnu.org/software/gawk/manual/" title="gawk manual on GNU site">Awk</a>
 would, in many ways, be a better tool for this job. Essentially, we want to
 manage three lists: the modules in <span class="file">/proc/modules</span>, a
 list of modules to ignore, and the master list of all modules required prior to
 compilation. This seems perfectly suited to Awk.</p>

<p> So, in the interests of learning Awk, I decided to rewrite the required
 functionality (or, more correctly, the subset that I required) in this
 language. This wasn&#8217;t a straightforward task for me. I got stuck a couple of
 times and, as I work in a building full of
 <a href="http://catalyst.net.nz" title="Catalyst website">neckbeards</a>, I thought I could ask
 for a couple of pointers. To my surprise, no-one I asked seemed interested in
 Awk. Typical responses were along the lines of “just use Perl.”</p>

<p> Aside from not knowing any
 <a href="http://www.perl.org/" title="Perl homepage">Perl</a>, and being unlikely to learn any
 in the immediate future, I was bemused by the notion that none of these skilled
 developers rated Awk as a language worth knowing. One of the #awk FAQ&#8217;s
 specifically addresses this:
 <a href="http://awk.freeshell.org/Frequently_Asked_Questions#toc14" title="#awk FAQs">Why would anyone still use awk instead of perl?</a>
 The quote by Tom Christiansen is worth repeating here:</p>

<p> <blockquote><p>Awk is a venerable, powerful, elegant, and simple tool that everyone should know. Perl is a superset and child of awk, but has much more power that comes at expense of sacrificing some of that simplicity.</p></blockquote></p>

<p>In a happy coincidence, this
<a href="http://unix.stackexchange.com/questions/90489/compare-two-files-with-first-column-and-remove-duplicate-row-from-2nd-file-in-sh/90490#90490" title="Comparing two files">question on Unix &amp; Linux SE</a>
showed up just as I was completing my script and it neatly illustrates (to my
unututored eye, anyway) an example of a typical situation where Awk&#8217;s strengths
make it a better approach than Perl.</p>

<p>In any event, my rewriting of <code>modprobed_db</code> in Awk<sup>1</sup> resulted in this:</p>

<figure class='code'><figcaption><span>awkmodules </span></figcaption>
 <div class="highlight"><pre><code class='awk'><span class='line'><span class="c1">#!/usr/bin/awk -f</span>
</span><span class='line'><span class="c1"># script to manage modules for kernel builds</span>
</span><span class='line'>
</span><span class='line'><span class="nx">BEGIN</span> <span class="p">{</span> <span class="nx">dbfile</span> <span class="o">=</span> <span class="nb">ARGV</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="kd">function</span> <span class="nx">red</span><span class="p">(</span><span class="nx">s</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>    <span class="kr">printf</span> <span class="s2">&quot;\033[1;31m&quot;</span> <span class="nx">s</span> <span class="s2">&quot;\033[0m &quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># read in the array</span>
</span><span class='line'><span class="nb">FILENAME</span> <span class="o">!=</span> <span class="nb">ARGV</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">modlist</span><span class="p">[</span><span class="o">$</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span><span class="p">;</span> <span class="kr">next</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># check for ignored modules</span>
</span><span class='line'><span class="o">!</span><span class="nx">modlist</span><span class="p">[</span><span class="o">$</span><span class="mi">1</span><span class="p">]</span><span class="o">++</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">print</span> <span class="o">$</span><span class="mi">1</span> <span class="o">&gt;&gt;</span> <span class="nx">dbfile</span>
</span><span class='line'>  <span class="kr">close</span><span class="p">(</span><span class="nx">dbfile</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="c1"># modprobe modules</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span><span class="nx">p</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">modload</span><span class="o">=</span><span class="s2">&quot;sudo modprobe -a $(&lt;&quot;</span><span class="nx">dbfile</span><span class="s2">&quot;)&quot;</span>
</span><span class='line'>  <span class="kr">system</span><span class="p">(</span><span class="nx">modload</span><span class="p">)</span>
</span><span class='line'>  <span class="kr">close</span><span class="p">(</span><span class="nx">modload</span><span class="p">)</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="p">{</span>
</span><span class='line'><span class="c1"># update module count</span>
</span><span class='line'><span class="k">if</span> <span class="p">(</span> <span class="kr">getline</span> <span class="o">&lt;</span> <span class="nx">dbfile</span> <span class="p">)</span> <span class="p">{</span>
</span><span class='line'>  <span class="nx">count</span><span class="o">++</span>
</span><span class='line'>  <span class="p">}</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="nx">END</span> <span class="p">{</span>
</span><span class='line'>  <span class="kr">print</span> <span class="nx">red</span><span class="p">(</span><span class="nx">count</span><span class="p">)</span> <span class="s2">&quot;modules listed.&quot;</span>
</span><span class='line'><span class="p">}</span>
</span><span class='line'>
</span><span class='line'><span class="c1"># vim:set ts=2 sts=2 sw=2 et:</span>
</span></code></pre></div></figure>


<p>Just prior to compiling a kernel, I can invoke this script with (the admittedly
rather ungainly line):</p>

<figure class='code'> <div class="highlight"><pre><code class='sh'><span class='line'>awkmodules <span class="nv">p</span><span class="o">=</span>1 .config/kmod_db/ignored .config/kmod_db/modules_db /proc/modules
</span></code></pre></div></figure>


<p>It does work, but I don&#8217;t claim that it is either idiomatic or attractive. The
use of <code>getline</code> to update the module count strikes me as especially kludgy but
I haven&#8217;t been able to think of a more correct way to handle it.</p>

<p>Incidentally, the gawk manual<sup>2</sup>,
<a href="http://www.gnu.org/software/gawk/manual/" title="GNU goodness">Gawk: Effective AWK Programming</a>
has only just been updated<sup>3</sup> so Awk is, unlike it&#8217;s homonym, clearly
alive and well.</p>

<h4>Notes</h4>

<ol>
<li>In my <a href="https://bitbucket.org/jasonwryan/shiv/src/tip/Scripts/awkmodules">bitbucket repo</a>.</li>
<li>The number of variants of <code>awk</code> is as much a delight as it is perplexing…</li>
<li>May, 2013</li>
</ol>


<p>Public Domain image of the Great Auk by John James Audubon, from his book
<a href="https://en.wikipedia.org/wiki/File:PinguinusImpennus.jpg">The Birds of America</a>.</p>
</div>
  
  


    </article>
  
  
    <article>
      
  <header>
    
      <h1 class="entry-title"><a href="/blog/2013/08/24/automating-kernels/">Automating Kernel Builds</a></h1>
    
    
      <p class="meta">
        








  


<time datetime="2013-08-24T10:30:00+12:00" pubdate data-updated="true">Aug 24<span>th</span>, 2013</time>
        
      </p>
    
  </header>


  <div class="entry-content"><p><img class="left" src="http://miromiro.com/Blog-images/robot.jpg" title="I Robot" >
I posted a couple of weeks ago about
<a href="http://jasonwryan.com/blog/2013/08/03/kernels/" title="Check it if you haven't...">compiling a custom kernel</a>
using <a href="https://github.com/graysky2/modprobed_db" title="graysky's github repo">modprobed_db</a>
and at the time I talked about automating the process, essentially so that every
kernel update, be it the standard Arch kernel or the stripped down custom one,
would be a simple, streamlined process. I updated that post with
<a href="https://bitbucket.org/jasonwryan/shiv/src/tip/Build/linux-jwr/PKGBUILD" title="bitbucket repo">a PKGBUILD</a>,
which was the first step. This completes that process.</p>

<p>There is not a lot to it. A
<a href="https://bitbucket.org/jasonwryan/shiv/src/tip/Scripts/new_kernel" title="bitbucket repo">short bash wrapper</a>
that sets up the required files, updates the aforementioned PKGBUILD and then
triggers <code>makepkg</code> (providing nothing else fails). All it requires is that you
have
<a href="https://bitbucket.org/jasonwryan/shiv/src/tip/Build/linux-jwr%20'You%20guessed%20it%E2%80%A6">the necessary files</a>
in a separate directory for the script to reference and
you are set. If anything does go wrong with the new kernel, you still have the
previous working custom kernel <code>.tar.xz</code> you can reinstall, or you can of course
just boot into the vanilla Arch kernel.</p>

<figure class='code'><figcaption><span>new_kernel </span></figcaption>
 <div class="highlight"><pre><code class='bash'><span class='line'><span class="c">#!/usr/bin/env bash</span>
</span><span class='line'><span class="c"># install new kernel</span>
</span><span class='line'>
</span><span class='line'><span class="nv">vers</span><span class="o">=</span><span class="nv">$1</span>
</span><span class='line'><span class="nv">cyn</span><span class="o">=</span><span class="s1">$&#39;\e[1;36m&#39;</span>
</span><span class='line'><span class="nv">ylw</span><span class="o">=</span><span class="s1">$&#39;\e[1;33m&#39;</span>
</span><span class='line'><span class="nv">red</span><span class="o">=</span><span class="s1">$&#39;\e[1;31m&#39;</span>
</span><span class='line'><span class="nv">end</span><span class="o">=</span><span class="s1">$&#39;\e[0m&#39;</span>
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$# </span>!<span class="o">=</span> 1 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&quot;Usage: &quot;</span><span class="k">${</span><span class="nv">0</span><span class="p">##*/</span><span class="k">}</span><span class="s2">&quot; 3.10.8&quot;</span>
</span><span class='line'>  <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'>
</span><span class='line'><span class="c"># back up last dir</span>
</span><span class='line'><span class="nb">cd</span> ~/Build
</span><span class='line'>rm -rf linux-jwr/<span class="o">{</span>pkg,src<span class="o">}</span>
</span><span class='line'>mv linux-jwr linux-<span class="k">${</span><span class="nv">vers</span><span class="p">%.*</span><span class="k">}</span>.<span class="k">$((${</span><span class="nv">vers</span><span class="p">##*.</span><span class="k">}</span> <span class="o">-</span> <span class="m">1</span><span class="k">))</span>
</span><span class='line'>
</span><span class='line'><span class="c"># set up clean files</span>
</span><span class='line'>cp -r kernel_files linux-jwr <span class="o">&amp;&amp;</span> <span class="nb">cd</span> <span class="s2">&quot;$_&quot;</span>
</span><span class='line'>
</span><span class='line'>sed -i <span class="s2">&quot;s:pkgver=[0-9].*:pkgver=${vers}:&quot;</span> PKGBUILD
</span><span class='line'><span class="nv">newvers</span><span class="o">=</span><span class="k">$(</span>awk -F<span class="o">=</span> <span class="s1">&#39;/pkgver=/ {print $2}&#39;</span> PKGBUILD<span class="k">)</span>
</span><span class='line'><span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&quot;Package version updated to ${ylw}$newvers${end}&quot;</span>
</span><span class='line'>
</span><span class='line'><span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&quot;${cyn}Updating checksums…${end}&quot;</span>
</span><span class='line'>/usr/bin/updpkgsums
</span><span class='line'>
</span><span class='line'><span class="k">if</span> <span class="o">[[</span> <span class="nv">$?</span> -eq 0 <span class="o">]]</span>; <span class="k">then</span>
</span><span class='line'><span class="k">  </span><span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&quot;${cyn}Starting build…${end}&quot;</span>
</span><span class='line'>  /usr/bin/time /usr/bin/makepkg -i
</span><span class='line'><span class="k">else</span>
</span><span class='line'><span class="k">  </span><span class="nb">printf</span> <span class="s1">&#39;%s\n&#39;</span> <span class="s2">&quot;${red}Checksum failed${end}&quot;</span>
</span><span class='line'>  <span class="nb">exit </span>1
</span><span class='line'><span class="k">fi</span>
</span><span class='line'><span class="nb">cd</span>
</span></code></pre></div></figure>


<p>That&#8217;s all there is to it. I see in my RSS reader that a new stable kernel is
available, open a terminal and run the script specifying which version to use,
for example, <code>new_kernel 3.10.9</code>.  Approximately 10 minutes later, my new kernel
is compiled and installed and I can reboot into it. Simple.</p>

<p>Undoubtedly, there is probably a cleaner way to do this, but it has worked well
for the last couple of kernels. It will probably also require tweaking for the
next series, but until that time, I am quite happy with it.</p>

<h4>Notes</h4>

<p>Flickr creative commons image
<a href="http://www.flickr.com/photos/fringley/4244586360/">My robot</a> by fringley.</p>
</div>
  
  


    </article>
  
  <div class="pagination">
    
      <a class="prev" href="/blog/page/3/">&larr; Older</a>
    
    <a href="/blog/archives">Blog Archives</a>
    
    <a class="next" href="/">Newer &rarr;</a>
    
  </div>
</div>
<aside class="sidebar">
  
    <section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/blog/2014/01/20/udev/">Scripting with udev</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/12/28/hostsblock/">Ad Blocking with Hostsblock</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/11/14/api/">BitTorrent Sync&#8217;s API</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/10/28/dismount/">Simple Unmounting</a>
      </li>
    
      <li class="post">
        <a href="/blog/2013/09/15/awking/">Managing modules with Awk</a>
      </li>
    
  </ul>
</section>

<section>
  <h1>Pinboard</h1>
  <ul id="pinboard_linkroll">Fetching linkroll&#8230;</ul>
  <p><a href="http://pinboard.in/u:jasonwryan">My Pinboard Bookmarks &raquo;</a></p>
</section>
<script type="text/javascript">
  var linkroll = 'pinboard_linkroll'; //id target for pinboard list
  var pinboard_user = "jasonwryan"; //id target for pinboard list
  var pinboard_count = 3; //id target for pinboard list
  (function(){
    var pinboardInit = document.createElement('script');
    pinboardInit.type = 'text/javascript';
    pinboardInit.async = true;
    pinboardInit.src = '/javascripts/pinboard.js';
    document.getElementsByTagName('head')[0].appendChild(pinboardInit);
  })();
</script>


<section class="lastfm">
<h1>Recently Scrobbled</h1>
<style type="text/css">
  #lastfmList li{ text-align: left; }
</style>
<ul id="lastfmList">
  <li class="loading">Updating tracks&#8230;</li>
</ul>
<p><a href="http://alpha.libre.fm/user/jasonwryan">My tunes on Libre.fm &raquo;</a></p>

<script type="text/javascript">
  $.domReady(function(){
    getLastfmFeed("jasonwryan", 5, "3a19a6604d742024a1331bebb7a68d33");
  });
</script>
<script src="/javascripts/twitter.js" type="text/javascript"> </script>

<script lang="Javascript">
function getLastfmFeed(user,count,api_key) {
  count = parseInt(count, 10);
  $.ajax({
      url: "http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&user=" + user + "&limit=" + count + "&api_key=" + api_key
    , type: 'xml'
    , error: function (err) { $('#lastfmList li.loading').addClass('error').text("Last.fm's busted"); }
    , success: function(data) { showLastfmFeed(data); }
  });
}

function showLastfmFeed(xml){
  var tracklist = document.getElementById('lastfmList'),
      content = '',
      i=0;
  
  $(xml.responseXML).find("recenttracks").children().each(function(){
    var artist = $(this).find('artist').text(),
        name = $(this).find('name').text(),
        date = $(this).find('date').text(),
        url = $(this).find('url').text();
    content += '<li id="lastfmItem_'+i+'"><a href="'+ url + '">' + name +'</a> by '+ artist + '<span class="date"> ' + prettyDate(date) + ' ago</span></li>';
    i+=1;
  });

  tracklist.innerHTML = content;
}
</script>
</section>

<section>
<p class="arch"><a href="http://unix.stackexchange.com/users/6761/jasonwryan">
<img src="http://unix.stackexchange.com/users/flair/6761.png" border="0" width="208" height="58" alt="profile for jasonwryan at Unix and Linux, Q&amp;A for users of Linux, FreeBSD and other Un*x-like operating systems." title="profile for jasonwryan at Unix and Linux, Q&amp;A for users of Linux, FreeBSD and other Un*x-like operating systems.">
</a></p>
</section>
<section>
<p class="arch"><a href="https://archlinux.org/" title="Arch Linux"><img src="http://dl.dropbox.com/u/261312/running-on-arch.png" /></a></p>
</section>

  
</aside>

    </div>
  </div>
  <footer role="contentinfo"><p>
All content licensed under <a href="http://creativecommons.org/licenses/by/2.5/" title="Creative Commons by Attribution">Creative Commons</a> 2014 - Jason Ryan    
<span class="credit">This site is powered by <a href="http://vim.org">Vim</a>, <a href="http://octopress.org">Octopress</a> and <a href="http://github.com">Github</a></span>
</p>

</footer>
  

<script type="text/javascript">
      var disqus_shortname = 'jasonwryan';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>











</body>
</html>
